<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Patient Medical Intake | Range Medical</title>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- EmailJS for sending emails -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <!-- Signature Pad -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    
    <!-- Supabase for file storage -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        :root {
            --black: #000000;
            --white: #ffffff;
            --gray-50: #fafafa;
            --gray-100: #f5f5f5;
            --gray-200: #e5e5e5;
            --gray-300: #d4d4d4;
            --gray-400: #a3a3a3;
            --gray-500: #737373;
            --gray-600: #525252;
            --gray-700: #404040;
            --gray-800: #262626;
            --gray-900: #171717;
            --error: #dc2626;
            --success: #16a34a;
        }
        
        html {
            font-size: 16px;
        }
        
        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--gray-100);
            color: var(--gray-900);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 2.5rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid var(--black);
        }
        
        .clinic-name {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: 0.15em;
            margin-bottom: 0.5rem;
            color: var(--black);
        }
        
        .form-title {
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            margin-top: 0.5rem;
            color: var(--gray-700);
        }
        
        .header p {
            color: var(--gray-600);
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        
        /* Form Styles */
        .form-container {
            background: var(--white);
            border: 2px solid var(--black);
            padding: 2rem;
        }
        
        .section {
            margin-bottom: 2.5rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .section:last-of-type {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .section-title {
            font-size: 1.125rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--black);
            display: inline-block;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.25rem;
            margin-bottom: 1.25rem;
        }
        
        .form-row:last-child {
            margin-bottom: 0;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        label {
            font-size: 0.8125rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
        }
        
        label .required {
            color: var(--error);
            margin-left: 2px;
        }
        
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            font-family: inherit;
            border: 1.5px solid var(--gray-300);
            background: var(--white);
            color: var(--gray-900);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--black);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }
        
        input.error,
        select.error,
        textarea.error {
            border-color: var(--error);
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23525252' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
        }
        
        /* Checkbox Group */
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.75rem;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
            accent-color: var(--black);
        }
        
        .checkbox-item label {
            font-size: 0.9375rem;
            font-weight: 500;
            text-transform: none;
            letter-spacing: normal;
            margin-bottom: 0;
            cursor: pointer;
            color: var(--gray-800);
        }
        
        /* Radio Group */
        .radio-group {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        
        .radio-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        
        .radio-item input[type="radio"] {
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
            accent-color: var(--black);
        }
        
        .radio-item label {
            font-size: 0.9375rem;
            font-weight: 500;
            text-transform: none;
            letter-spacing: normal;
            margin-bottom: 0;
            cursor: pointer;
            color: var(--gray-800);
        }
        
        /* Conditional Fields */
        .conditional-field {
            display: none;
            margin-top: 1rem;
            padding-left: 1.75rem;
            border-left: 3px solid var(--gray-300);
        }
        
        .conditional-field.visible {
            display: block;
        }
        
        /* Condition Items with Details */
        .condition-item {
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--gray-100);
        }
        
        .condition-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .condition-details {
            display: none;
            margin-top: 0.75rem;
            margin-left: 1.75rem;
            padding: 1rem;
            background: var(--gray-50);
            border-left: 3px solid var(--gray-300);
        }
        
        .condition-details.visible {
            display: block;
        }
        
        .condition-details .form-group {
            margin-bottom: 0;
        }
        
        .condition-details .form-row {
            gap: 1rem;
        }
        
        /* File Upload */
        .file-upload {
            position: relative;
        }
        
        .file-upload-input {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .file-upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            border: 2px dashed var(--gray-300);
            background: var(--gray-50);
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s ease, background-color 0.2s ease;
        }
        
        .file-upload-label:hover {
            border-color: var(--black);
            background: var(--gray-100);
        }
        
        .file-upload-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .file-upload-text {
            font-size: 0.875rem;
            color: var(--gray-600);
        }
        
        .file-preview {
            margin-top: 1rem;
            display: none;
        }
        
        .file-preview.visible {
            display: block;
        }
        
        .file-preview img {
            max-width: 200px;
            max-height: 150px;
            border: 1px solid var(--gray-300);
        }
        
        /* Signature Pad */
        .signature-container {
            border: 1.5px solid var(--gray-300);
            background: var(--white);
        }
        
        .signature-pad {
            width: 100%;
            height: 150px;
            display: block;
        }
        
        .signature-actions {
            display: flex;
            gap: 1rem;
            margin-top: 0.75rem;
        }
        
        .btn-clear {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            background: var(--white);
            border: 1.5px solid var(--gray-400);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-clear:hover {
            border-color: var(--black);
            background: var(--gray-100);
        }
        
        /* Consent Box */
        .consent-box {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .consent-text {
            font-size: 0.9375rem;
            line-height: 1.7;
            color: var(--gray-700);
            margin-bottom: 1rem;
        }
        
        /* Submit Button */
        .submit-section {
            margin-top: 2.5rem;
            padding-top: 2rem;
            border-top: 2px solid var(--black);
        }
        
        .btn-submit {
            width: 100%;
            padding: 1.25rem 2rem;
            font-size: 1.125rem;
            font-weight: 700;
            font-family: inherit;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            background: var(--black);
            color: var(--white);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-submit:hover {
            background: var(--gray-800);
            transform: translateY(-1px);
        }
        
        .btn-submit:active {
            transform: translateY(0);
        }
        
        .btn-submit:disabled {
            background: var(--gray-400);
            cursor: not-allowed;
            transform: none;
        }
        
        /* Status Messages */
        .status-message {
            padding: 1rem;
            margin-top: 1rem;
            text-align: center;
            font-weight: 600;
            display: none;
        }
        
        .status-message.visible {
            display: block;
        }
        
        .status-message.success {
            background: #dcfce7;
            color: var(--success);
            border: 1px solid var(--success);
        }
        
        .status-message.error {
            background: #fee2e2;
            color: var(--error);
            border: 1px solid var(--error);
        }
        
        .status-message.loading {
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }
        
        /* Error Messages */
        .field-error {
            font-size: 0.8125rem;
            color: var(--error);
            margin-top: 0.375rem;
            display: none;
        }
        
        .field-error.visible {
            display: block;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            margin-top: 2rem;
            padding-top: 1.5rem;
            font-size: 0.8125rem;
            color: var(--gray-500);
        }
        
        /* Thank You Page */
        .thank-you-page {
            background: var(--white);
            border: 2px solid var(--black);
            padding: 3rem 2rem;
            text-align: center;
            max-width: 600px;
            margin: 2rem auto;
        }
        
        .thank-you-icon {
            width: 80px;
            height: 80px;
            background: var(--black);
            color: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin: 0 auto 1.5rem auto;
        }
        
        .thank-you-page h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--black);
        }
        
        .thank-you-subtitle {
            font-size: 1.125rem;
            color: var(--gray-600);
            margin-bottom: 2rem;
        }
        
        .thank-you-details {
            background: var(--gray-50);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-left: 4px solid var(--black);
            text-align: left;
        }
        
        .thank-you-details p {
            margin-bottom: 0.75rem;
            color: var(--gray-700);
        }
        
        .thank-you-details p:last-child {
            margin-bottom: 0;
        }
        
        .thank-you-contact {
            margin-bottom: 2rem;
        }
        
        .thank-you-contact h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--gray-800);
        }
        
        .thank-you-contact a {
            color: var(--black);
            text-decoration: underline;
        }
        
        .thank-you-footer {
            padding-top: 1.5rem;
            border-top: 1px solid var(--gray-200);
        }
        
        .thank-you-footer p {
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            color: var(--black);
        }
        
        /* PDF Styles - Hidden version for PDF generation */
        .pdf-content {
            display: none;
        }
        
        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 1rem;
            }
            
            .form-container {
                padding: 1.5rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
            }
            
            .radio-group {
                flex-direction: column;
                gap: 0.75rem;
            }
        }
        
        /* Print/PDF Styles */
        @media print {
            body {
                background: white;
            }
            
            .container {
                max-width: 100%;
                padding: 0;
            }
            
            .form-container {
                border: none;
                box-shadow: none;
            }
            
            .btn-submit,
            .btn-clear,
            .file-upload,
            .status-message {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="clinic-name">RANGE MEDICAL</h1>
            <h2 class="form-title">New Patient Medical Intake Form</h2>
            <p>Please complete all required fields marked with *</p>
        </header>
        
        <div class="form-container">
            <form id="intakeForm" novalidate>
                
                <!-- Personal Information -->
                <div class="section">
                    <h2 class="section-title">Personal Information</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName">First Name <span class="required">*</span></label>
                            <input type="text" id="firstName" name="firstName" required>
                            <span class="field-error" id="firstNameError">First name is required</span>
                        </div>
                        <div class="form-group">
                            <label for="lastName">Last Name <span class="required">*</span></label>
                            <input type="text" id="lastName" name="lastName" required>
                            <span class="field-error" id="lastNameError">Last name is required</span>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="gender">Gender <span class="required">*</span></label>
                            <select id="gender" name="gender" required>
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Non-binary">Non-binary</option>
                                <option value="Prefer not to say">Prefer not to say</option>
                                <option value="Other">Other</option>
                            </select>
                            <span class="field-error" id="genderError">Gender is required</span>
                        </div>
                        <div class="form-group">
                            <label for="dob">Date of Birth <span class="required">*</span></label>
                            <input type="date" id="dob" name="dob" required>
                            <span class="field-error" id="dobError">Date of birth is required</span>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="email">Email <span class="required">*</span></label>
                            <input type="email" id="email" name="email" required>
                            <span class="field-error" id="emailError">Valid email is required</span>
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone <span class="required">*</span></label>
                            <input type="tel" id="phone" name="phone" placeholder="(555) 555-5555" required>
                            <span class="field-error" id="phoneError">Phone number is required</span>
                        </div>
                    </div>
                </div>
                
                <!-- Address -->
                <div class="section">
                    <h2 class="section-title">Address</h2>
                    
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="streetAddress">Street Address <span class="required">*</span></label>
                            <input type="text" id="streetAddress" name="streetAddress" required>
                            <span class="field-error" id="streetAddressError">Street address is required</span>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="city">City <span class="required">*</span></label>
                            <input type="text" id="city" name="city" required>
                            <span class="field-error" id="cityError">City is required</span>
                        </div>
                        <div class="form-group">
                            <label for="state">State <span class="required">*</span></label>
                            <input type="text" id="state" name="state" required>
                            <span class="field-error" id="stateError">State is required</span>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="country">Country <span class="required">*</span></label>
                            <input type="text" id="country" name="country" value="United States" required>
                            <span class="field-error" id="countryError">Country is required</span>
                        </div>
                        <div class="form-group">
                            <label for="postalCode">Postal Code <span class="required">*</span></label>
                            <input type="text" id="postalCode" name="postalCode" required>
                            <span class="field-error" id="postalCodeError">Postal code is required</span>
                        </div>
                    </div>
                </div>
                
                <!-- Health Concerns & Symptoms -->
                <div class="section">
                    <h2 class="section-title">Health Concerns & Symptoms</h2>
                    
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="whatBringsYou">What Brings You In Today? <span class="required">*</span></label>
                            <textarea id="whatBringsYou" name="whatBringsYou" rows="4" placeholder="Please describe your health concerns, symptoms, or wellness goals..." required></textarea>
                            <span class="field-error" id="whatBringsYouError">This field is required</span>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Are you injured? <span class="required">*</span></label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" id="injuredYes" name="injured" value="Yes" required>
                                    <label for="injuredYes">Yes</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="injuredNo" name="injured" value="No">
                                    <label for="injuredNo">No</label>
                                </div>
                            </div>
                            <span class="field-error" id="injuredError">Please select an option</span>
                            
                            <div class="conditional-field" id="injuryFields">
                                <div class="form-row">
                                    <div class="form-group full-width">
                                        <label for="injuryDescription">What is your injury? <span class="required">*</span></label>
                                        <textarea id="injuryDescription" name="injuryDescription" rows="2" placeholder="Describe your injury..."></textarea>
                                        <span class="field-error" id="injuryDescriptionError">Please describe your injury</span>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="injuryLocation">Where is it located? <span class="required">*</span></label>
                                        <input type="text" id="injuryLocation" name="injuryLocation" placeholder="e.g., Lower back, Right knee">
                                        <span class="field-error" id="injuryLocationError">Please specify the location</span>
                                    </div>
                                    <div class="form-group">
                                        <label for="injuryDate">When did it occur?</label>
                                        <input type="text" id="injuryDate" name="injuryDate" placeholder="e.g., 2 weeks ago, January 2024">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Medical History -->
                <div class="section">
                    <h2 class="section-title">Medical History</h2>
                    <p style="margin-bottom: 1.5rem; color: var(--gray-700); font-size: 0.9375rem;">Please answer YES or NO for each condition. If YES, provide details to help us serve you better.</p>
                    
                    <!-- CARDIOVASCULAR CONDITIONS -->
                    <div style="background-color: #fef2f2; border-left: 4px solid #dc2626; padding: 1rem; margin-bottom: 1.5rem; border-radius: 4px;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 0.875rem; font-weight: 700; text-transform: uppercase; color: #991b1b; letter-spacing: 0.5px;">‚ù§Ô∏è Cardiovascular Conditions</h3>
                        
                        <!-- Hypertension -->
                        <div class="condition-item">
                            <label class="condition-label"><strong>High Blood Pressure (Hypertension)</strong> <span class="required">*</span></label>
                            <div class="radio-group" style="margin-bottom: 0.5rem;">
                                <div class="radio-item">
                                    <input type="radio" id="hypertension_yes" name="hypertension" value="Yes" required class="condition-radio">
                                    <label for="hypertension_yes">Yes</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="hypertension_no" name="hypertension" value="No" class="condition-radio">
                                    <label for="hypertension_no">No</label>
                                </div>
                            </div>
                            <div class="condition-details" id="hypertension-details" style="display: none;">
                                <div class="form-group">
                                    <label for="hypertension-year">Year Diagnosed</label>
                                    <input type="text" id="hypertension-year" name="hypertensionYear" placeholder="e.g., 2020">
                                </div>
                            </div>
                        </div>
                        
                        <!-- High Cholesterol -->
                        <div class="condition-item">
                            <label class="condition-label"><strong>High Cholesterol</strong> <span class="required">*</span></label>
                            <div class="radio-group" style="margin-bottom: 0.5rem;">
                                <div class="radio-item">
                                    <input type="radio" id="highCholesterol_yes" name="highCholesterol" value="Yes" required class="condition-radio">
                                    <label for="highCholesterol_yes">Yes</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="highCholesterol_no" name="highCholesterol" value="No" class="condition-radio">
                                    <label for="highCholesterol_no">No</label>
                                </div>
                            </div>
                            <div class="condition-details" id="highCholesterol-details" style="display: none;">
                                <div class="form-group">
                                    <label for="highCholesterol-year">Year Diagnosed</label>
                                    <input type="text" id="highCholesterol-year" name="highCholesterolYear" placeholder="e.g., 2020">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Heart Disease -->
                        <div class="condition-item">
                            <label class="condition-label"><strong>Heart Disease</strong> <span class="required">*</span></label>
                            <div class="radio-group" style="margin-bottom: 0.5rem;">
                                <div class="radio-item">
                                    <input type="radio" id="heartDisease_yes" name="heartDisease" value="Yes" required class="condition-radio">
                                    <label for="heartDisease_yes">Yes</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="heartDisease_no" name="heartDisease" value="No" class="condition-radio">
                                    <label for="heartDisease_no">No</label>
                                </div>
                            </div>
                            <div class="condition-details" id="heartDisease-details" style="display: none;">
                                <div class="form-row" style="margin-bottom: 0;">
                                    <div class="form-group">
                                        <label for="heartDisease-type">Type of Heart Disease</label>
                                        <input type="text" id="heartDisease-type" name="heartDiseaseType" placeholder="e.g., CHF, CAD, Valve Disease, Arrhythmia">
                                    </div>
                                    <div class="form-group">
                                        <label for="heartDisease-year">Year Diagnosed</label>
                                        <input type="text" id="heartDisease-year" name="heartDiseaseYear" placeholder="e.g., 2020">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- METABOLIC & ENDOCRINE CONDITIONS -->
                    <div style="background-color: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; margin-bottom: 1.5rem; border-radius: 4px;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 0.875rem; font-weight: 700; text-transform: uppercase; color: #92400e; letter-spacing: 0.5px;">‚ö° Metabolic & Endocrine Conditions</h3>
                        
                        <!-- Diabetes -->
                        <div class="condition-item">
                            <label class="condition-label"><strong>Diabetes</strong> <span class="required">*</span></label>
                            <div class="radio-group" style="margin-bottom: 0.5rem;">
                                <div class="radio-item">
                                    <input type="radio" id="diabetes_yes" name="diabetes" value="Yes" required class="condition-radio">
                                    <label for="diabetes_yes">Yes</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="diabetes_no" name="diabetes" value="No" class="condition-radio">
                                    <label for="diabetes_no">No</label>
                                </div>
                            </div>
                            <div class="condition-details" id="diabetes-details" style="display: none;">
                                <div class="form-row" style="margin-bottom: 0;">
                                    <div class="form-group">
                                        <label for="diabetes-type">Type of Diabetes</label>
                                        <input type="text" id="diabetes-type" name="diabetesType" placeholder="Type 1, Type 2, or Gestational">
                                    </div>
                                    <div class="form-group">
                                        <label for="diabetes-year">Year Diagnosed</label>
                                        <input type="text" id="diabetes-year" name="diabetesYear" placeholder="e.g., 2020">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Thyroid Disorder -->
                        <div class="condition-item">
                            <label class="condition-label"><strong>Thyroid Disorder</strong> <span class="required">*</span></label>
                            <div class="radio-group" style="margin-bottom: 0.5rem;">
                                <div class="radio-item">
                                    <input type="radio" id="thyroid_yes" name="thyroid" value="Yes" required class="condition-radio">
                                    <label for="thyroid_yes">Yes</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="thyroid_no" name="thyroid" value="No" class="condition-radio">
                                    <label for="thyroid_no">No</label>
                                </div>
                            </div>
                            <div class="condition-details" id="thyroid-details" style="display: none;">
                                <div class="form-row" style="margin-bottom: 0;">
                                    <div class="form-group">
                                        <label for="thyroid-type">Type of Thyroid Disorder</label>
                                        <input type="text" id="thyroid-type" name="thyroidType" placeholder="e.g., Hypothyroid, Hyperthyroid, Hashimoto's, Graves'">
                                    </div>
                                    <div class="form-group">
                                        <label for="thyroid-year">Year Diagnosed</label>
                                        <input type="text" id="thyroid-year" name="thyroidYear" placeholder="e.g., 2020">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- MENTAL HEALTH CONDITIONS -->
                    <div style="background-color: #ede9fe; border-left: 4px solid #8b5cf6; padding: 1rem; margin-bottom: 1.5rem; border-radius: 4px;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 0.875rem; font-weight: 700; text-transform: uppercase; color: #5b21b6; letter-spacing: 0.5px;">üß† Mental Health Conditions</h3>
                        
                        <!-- Depression / Anxiety -->
                        <div class="condition-item">
                            <label class="condition-label"><strong>Depression, Anxiety, or Other Mental Health Conditions</strong> <span class="required">*</span></label>
                            <div class="radio-group" style="margin-bottom: 0.5rem;">
                                <div class="radio-item">
                                    <input type="radio" id="depression_yes" name="depression" value="Yes" required class="condition-radio">
                                    <label for="depression_yes">Yes</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="depression_no" name="depression" value="No" class="condition-radio">
                                    <label for="depression_no">No</label>
                                </div>
                            </div>
                            <div class="condition-details" id="depression-details" style="display: none;">
                                <div class="form-group">
                                    <label for="depression-year">Year Diagnosed</label>
                                    <input type="text" id="depression-year" name="depressionYear" placeholder="e.g., 2020">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ORGAN HEALTH CONDITIONS -->
                    <div style="background-color: #dbeafe; border-left: 4px solid #3b82f6; padding: 1rem; margin-bottom: 1.5rem; border-radius: 4px;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 0.875rem; font-weight: 700; text-transform: uppercase; color: #1e40af; letter-spacing: 0.5px;">ü´Å Organ Health Conditions</h3>
                        
                        <!-- Kidney Disease -->
                        <div class="condition-item">
                            <label class="condition-label"><strong>Kidney Disease</strong> <span class="required">*</span></label>
                            <div class="radio-group" style="margin-bottom: 0.5rem;">
                                <div class="radio-item">
                                    <input type="radio" id="kidney_yes" name="kidney" value="Yes" required class="condition-radio">
                                    <label for="kidney_yes">Yes</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="kidney_no" name="kidney" value="No" class="condition-radio">
                                    <label for="kidney_no">No</label>
                                </div>
                            </div>
                            <div class="condition-details" id="kidney-details" style="display: none;">
                                <div class="form-row" style="margin-bottom: 0;">
                                    <div class="form-group">
                                        <label for="kidney-type">Type of Kidney Disease</label>
                                        <input type="text" id="kidney-type" name="kidneyType" placeholder="e.g., CKD, Kidney Stones, Polycystic Kidney Disease">
                                    </div>
                                    <div class="form-group">
                                        <label for="kidney-year">Year Diagnosed</label>
                                        <input type="text" id="kidney-year" name="kidneyYear" placeholder="e.g., 2020">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Liver Disease -->
                        <div class="condition-item">
                            <label class="condition-label"><strong>Liver Disease</strong> <span class="required">*</span></label>
                            <div class="radio-group" style="margin-bottom: 0.5rem;">
                                <div class="radio-item">
                                    <input type="radio" id="liver_yes" name="liver" value="Yes" required class="condition-radio">
                                    <label for="liver_yes">Yes</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="liver_no" name="liver" value="No" class="condition-radio">
                                    <label for="liver_no">No</label>
                                </div>
                            </div>
                            <div class="condition-details" id="liver-details" style="display: none;">
                                <div class="form-row" style="margin-bottom: 0;">
                                    <div class="form-group">
                                        <label for="liver-type">Type of Liver Disease</label>
                                        <input type="text" id="liver-type" name="liverType" placeholder="e.g., Fatty Liver, Hepatitis, Cirrhosis">
                                    </div>
                                    <div class="form-group">
                                        <label for="liver-year">Year Diagnosed</label>
                                        <input type="text" id="liver-year" name="liverYear" placeholder="e.g., 2020">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- IMMUNE SYSTEM & CANCER -->
                    <div style="background-color: #f3e8ff; border-left: 4px solid #a855f7; padding: 1rem; margin-bottom: 1.5rem; border-radius: 4px;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 0.875rem; font-weight: 700; text-transform: uppercase; color: #6b21a8; letter-spacing: 0.5px;">üõ°Ô∏è Immune System & Cancer</h3>
                        
                        <!-- Autoimmune -->
                        <div class="condition-item">
                            <label class="condition-label"><strong>Autoimmune Disorder</strong> <span class="required">*</span></label>
                            <div class="radio-group" style="margin-bottom: 0.5rem;">
                                <div class="radio-item">
                                    <input type="radio" id="autoimmune_yes" name="autoimmune" value="Yes" required class="condition-radio">
                                    <label for="autoimmune_yes">Yes</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="autoimmune_no" name="autoimmune" value="No" class="condition-radio">
                                    <label for="autoimmune_no">No</label>
                                </div>
                            </div>
                            <div class="condition-details" id="autoimmune-details" style="display: none;">
                                <div class="form-row" style="margin-bottom: 0;">
                                    <div class="form-group">
                                        <label for="autoimmune-type">Type of Autoimmune Disorder</label>
                                        <input type="text" id="autoimmune-type" name="autoimmuneType" placeholder="e.g., Lupus, Rheumatoid Arthritis, MS, Crohn's">
                                    </div>
                                    <div class="form-group">
                                        <label for="autoimmune-year">Year Diagnosed</label>
                                        <input type="text" id="autoimmune-year" name="autoimmuneYear" placeholder="e.g., 2020">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Cancer -->
                        <div class="condition-item">
                            <label class="condition-label"><strong>Cancer (Current or Past)</strong> <span class="required">*</span></label>
                            <div class="radio-group" style="margin-bottom: 0.5rem;">
                                <div class="radio-item">
                                    <input type="radio" id="cancer_yes" name="cancer" value="Yes" required class="condition-radio">
                                    <label for="cancer_yes">Yes</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="cancer_no" name="cancer" value="No" class="condition-radio">
                                    <label for="cancer_no">No</label>
                                </div>
                            </div>
                            <div class="condition-details" id="cancer-details" style="display: none;">
                                <div class="form-row" style="margin-bottom: 0;">
                                    <div class="form-group">
                                        <label for="cancer-type">Type of Cancer</label>
                                        <input type="text" id="cancer-type" name="cancerType" placeholder="e.g., Breast, Prostate, Lung, Skin">
                                    </div>
                                    <div class="form-group">
                                        <label for="cancer-year">Year Diagnosed</label>
                                        <input type="text" id="cancer-year" name="cancerYear" placeholder="e.g., 2020">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick No Conditions Option -->
                    <div style="background-color: #f0fdf4; border: 2px solid #22c55e; padding: 1rem; border-radius: 4px; margin-top: 1.5rem;">
                        <p style="margin: 0; color: #15803d; font-size: 0.9375rem;">
                            ‚úÖ <strong>No Medical Conditions?</strong> If you answered NO to all conditions above, you're all set with this section!
                        </p>
                    </div>
                </div>
                
                <!-- Medications & Allergies -->
                <div class="section">
                    <h2 class="section-title">Medications & Allergies</h2>
                    
                    <!-- HRT Question - Prominent -->
                    <div class="form-row">
                        <div class="form-group full-width" style="background-color: #dbeafe; border: 2px solid #3b82f6; padding: 1.5rem; border-radius: 4px; margin-bottom: 2rem;">
                            <label style="font-size: 1.125rem; font-weight: 600; color: #1e40af;margin-bottom: 1rem; display: block;">Are you currently on Hormone Replacement Therapy (HRT)? <span class="required">*</span></label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" id="hrtYes" name="onHRT" value="Yes" required>
                                    <label for="hrtYes">Yes</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="hrtNo" name="onHRT" value="No">
                                    <label for="hrtNo">No</label>
                                </div>
                            </div>
                            <span class="field-error" id="onHRTError">Please select an option</span>
                            
                            <div class="conditional-field" id="hrtFields" style="margin-top: 1rem;">
                                <div class="form-group">
                                    <label for="hrtDetails">HRT Details <span class="required">*</span></label>
                                    <textarea id="hrtDetails" name="hrtDetails" rows="2" placeholder="Please specify: type of HRT, dosage, frequency (e.g., Testosterone Cypionate 200mg weekly)"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Are you on any other Medications? <span class="required">*</span></label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" id="medicationsYes" name="onMedications" value="Yes" required>
                                    <label for="medicationsYes">Yes</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="medicationsNo" name="onMedications" value="No">
                                    <label for="medicationsNo">No</label>
                                </div>
                            </div>
                            <span class="field-error" id="onMedicationsError">Please select an option</span>
                            
                            <div class="conditional-field" id="medicationsFields">
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="currentMedications">Current Medications <span class="required">*</span></label>
                                    <textarea id="currentMedications" name="currentMedications" rows="3" placeholder="List all current medications"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="medicationNotes">Medication Notes</label>
                                    <textarea id="medicationNotes" name="medicationNotes" rows="2" placeholder="Any additional notes about your medications..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Do you have any allergies? <span class="required">*</span></label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" id="allergiesYes" name="hasAllergies" value="Yes" required>
                                    <label for="allergiesYes">Yes</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="allergiesNo" name="hasAllergies" value="No">
                                    <label for="allergiesNo">No</label>
                                </div>
                            </div>
                            <span class="field-error" id="hasAllergiesError">Please select an option</span>
                            
                            <div class="conditional-field" id="allergiesFields">
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="allergies">Allergies <span class="required">*</span></label>
                                    <textarea id="allergies" name="allergies" rows="3" placeholder="List all allergies (type 'No' if none)"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="allergyReactions">Allergy Reactions</label>
                                    <textarea id="allergyReactions" name="allergyReactions" rows="2" placeholder="Describe reactions to allergens..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Identification -->
                <div class="section">
                    <h2 class="section-title">Identification</h2>
                    
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Driver's License / Photo ID <span class="required">*</span></label>
                            <div class="file-upload">
                                <input type="file" id="photoId" name="photoId" class="file-upload-input" accept="image/*,.pdf" required>
                                <div class="file-upload-label">
                                    <span class="file-upload-icon">üìÑ</span>
                                    <span class="file-upload-text">Click or drag to upload your ID</span>
                                    <span class="file-upload-text" style="font-size: 0.75rem; margin-top: 0.25rem;">Accepted: JPG, PNG, PDF</span>
                                </div>
                            </div>
                            <div class="file-preview" id="idPreview">
                                <img id="idPreviewImg" alt="ID Preview">
                                <p id="idFileName" style="font-size: 0.875rem; color: var(--gray-600); margin-top: 0.5rem;"></p>
                            </div>
                            <span class="field-error" id="photoIdError">Photo ID is required</span>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="guardianName">Parent/Guardian Name (if client is under 18)</label>
                            <input type="text" id="guardianName" name="guardianName" placeholder="Leave blank if not applicable">
                        </div>
                    </div>
                </div>
                
                <!-- Consent -->
                <div class="section">
                    <h2 class="section-title">Consent & Acknowledgment</h2>
                    
                    <div class="consent-box">
                        <p class="consent-text">
                            I consent to evaluation and wellness services provided by Range Medical staff under the supervision of the medical director. I understand some therapies may be used off-label and that individual results can vary. I authorize Range Medical to contact me via the methods provided above. I acknowledge responsibility for payment for services rendered and have reviewed any posted cancellation/no-show policies.
                        </p>
                        
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="consentYes" name="consent" value="Yes" required>
                                <label for="consentYes">Yes, I agree</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="consentNo" name="consent" value="No">
                                <label for="consentNo">No, I do not agree</label>
                            </div>
                        </div>
                        <span class="field-error" id="consentError">Consent is required to proceed</span>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Patient or Guardian Signature <span class="required">*</span></label>
                            <div class="signature-container">
                                <canvas id="signaturePad" class="signature-pad"></canvas>
                            </div>
                            <div class="signature-actions">
                                <button type="button" class="btn-clear" id="clearSignature">Clear Signature</button>
                            </div>
                            <span class="field-error" id="signatureError">Signature is required</span>
                        </div>
                    </div>
                </div>
                
                <!-- Submit -->
                <div class="submit-section">
                    <button type="submit" class="btn-submit" id="submitBtn">
                        Submit Intake Form
                    </button>
                    
                    <div class="status-message" id="statusMessage"></div>
                </div>
            </form>
        </div>
        
        <footer class="footer">
            <p>&copy; 2025 Range Medical. All rights reserved.</p>
            <p style="margin-top: 0.5rem;">Your information is protected and kept confidential.</p>
        </footer>
    </div>
    
    <script>
        // ============================================
        // CONFIGURATION - YOUR EMAILJS SETTINGS
        // ============================================
        
        const CONFIG = {
            // EmailJS Configuration
            emailjs: {
                publicKey: 'ZeNFfwJ37Uhd6E1vp',
                serviceId: 'service_pyl6wra',
                templateId: 'template_3pfsl9b'
            },
            
            // Supabase Configuration (for PDF storage)
            supabase: {
                url: 'https://teivfptpozltpqwahgdl.supabase.co',
                anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRlaXZmcHRwb3psdHBxd2FoZ2RsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MTMxNDksImV4cCI6MjA4MDI4OTE0OX0.NrI1AykMBOh91mM9BFvpSH0JwzGrkv5ADDkZinh0elc'
            },
            
            // Email recipient for completed forms
            recipientEmail: 'cupp@range-medical.com',
            
            // Clinic information for PDF
            clinicName: 'Range Medical',
            clinicAddress: 'Your Address Here',
            clinicPhone: '(555) 555-5555'
        };
        
        // ============================================
        // SIGNATURE PAD INITIALIZATION
        // ============================================
        
        const canvas = document.getElementById('signaturePad');
        const signaturePad = new SignaturePad(canvas, {
            backgroundColor: 'rgb(255, 255, 255)',
            penColor: 'rgb(0, 0, 0)'
        });
        
        // Resize canvas to fit container
        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            const container = canvas.parentElement;
            canvas.width = container.offsetWidth * ratio;
            canvas.height = 150 * ratio;
            canvas.getContext('2d').scale(ratio, ratio);
            canvas.style.width = '100%';
            canvas.style.height = '150px';
            signaturePad.clear();
        }
        
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        
        // Clear signature button
        document.getElementById('clearSignature').addEventListener('click', function() {
            signaturePad.clear();
        });
        
        // ============================================
        // CONDITIONAL FIELDS
        // ============================================
        
        // Medical condition radio buttons - show/hide details
        document.querySelectorAll('.condition-radio').forEach(radio => {
            radio.addEventListener('change', function() {
                // Get the condition name from the radio button name attribute
                const conditionName = this.name;
                const detailsEl = document.getElementById(conditionName + '-details');
                
                if (detailsEl) {
                    if (this.value === 'Yes') {
                        detailsEl.style.display = 'block';
                    } else {
                        detailsEl.style.display = 'none';
                        // Clear the fields when No is selected
                        detailsEl.querySelectorAll('input, textarea').forEach(input => {
                            input.value = '';
                        });
                    }
                }
            });
        });
        
        // Injury conditional fields
        document.querySelectorAll('input[name="injured"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const field = document.getElementById('injuryFields');
                if (this.value === 'Yes') {
                    field.classList.add('visible');
                } else {
                    field.classList.remove('visible');
                    // Clear the fields when No is selected
                    document.getElementById('injuryDescription').value = '';
                    document.getElementById('injuryLocation').value = '';
                    document.getElementById('injuryDate').value = '';
                }
            });
        });
        
        // HRT conditional field
        document.querySelectorAll('input[name="onHRT"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const field = document.getElementById('hrtFields');
                if (this.value === 'Yes') {
                    field.classList.add('visible');
                } else {
                    field.classList.remove('visible');
                    document.getElementById('hrtDetails').value = '';
                }
            });
        });
        
        // Medications conditional field
        document.querySelectorAll('input[name="onMedications"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const field = document.getElementById('medicationsFields');
                if (this.value === 'Yes') {
                    field.classList.add('visible');
                } else {
                    field.classList.remove('visible');
                }
            });
        });
        
        // Allergies conditional field
        document.querySelectorAll('input[name="hasAllergies"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const field = document.getElementById('allergiesFields');
                if (this.value === 'Yes') {
                    field.classList.add('visible');
                } else {
                    field.classList.remove('visible');
                }
            });
        });
        
        // ============================================
        // FILE UPLOAD PREVIEW
        // ============================================
        
        document.getElementById('photoId').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('idPreview');
            const previewImg = document.getElementById('idPreviewImg');
            const fileName = document.getElementById('idFileName');
            
            if (file) {
                preview.classList.add('visible');
                fileName.textContent = file.name;
                
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImg.src = e.target.result;
                        previewImg.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    previewImg.style.display = 'none';
                }
            } else {
                preview.classList.remove('visible');
            }
        });
        
        // ============================================
        // PHONE NUMBER FORMATTING
        // ============================================
        
        document.getElementById('phone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 0) {
                if (value.length <= 3) {
                    value = '(' + value;
                } else if (value.length <= 6) {
                    value = '(' + value.slice(0, 3) + ') ' + value.slice(3);
                } else {
                    value = '(' + value.slice(0, 3) + ') ' + value.slice(3, 6) + '-' + value.slice(6, 10);
                }
            }
            e.target.value = value;
        });
        
        // ============================================
        // FORM VALIDATION
        // ============================================
        
        function validateForm() {
            let isValid = true;
            const errors = [];
            
            // Required text fields
            const requiredFields = [
                { id: 'firstName', error: 'firstNameError' },
                { id: 'lastName', error: 'lastNameError' },
                { id: 'gender', error: 'genderError' },
                { id: 'dob', error: 'dobError' },
                { id: 'email', error: 'emailError' },
                { id: 'phone', error: 'phoneError' },
                { id: 'streetAddress', error: 'streetAddressError' },
                { id: 'city', error: 'cityError' },
                { id: 'state', error: 'stateError' },
                { id: 'country', error: 'countryError' },
                { id: 'postalCode', error: 'postalCodeError' },
                { id: 'whatBringsYou', error: 'whatBringsYouError' }
            ];
            
            requiredFields.forEach(field => {
                const input = document.getElementById(field.id);
                const error = document.getElementById(field.error);
                
                if (!input.value.trim()) {
                    input.classList.add('error');
                    error.classList.add('visible');
                    isValid = false;
                } else {
                    input.classList.remove('error');
                    error.classList.remove('visible');
                }
            });
            
            // Email validation
            const email = document.getElementById('email');
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (email.value && !emailPattern.test(email.value)) {
                email.classList.add('error');
                document.getElementById('emailError').classList.add('visible');
                isValid = false;
            }
            
            // Required radio buttons
            const radioGroups = [
                { name: 'injured', error: 'injuredError' },
                { name: 'onMedications', error: 'onMedicationsError' },
                { name: 'hasAllergies', error: 'hasAllergiesError' },
                { name: 'consent', error: 'consentError' }
            ];
            
            radioGroups.forEach(group => {
                const checked = document.querySelector(`input[name="${group.name}"]:checked`);
                const error = document.getElementById(group.error);
                
                if (!checked) {
                    error.classList.add('visible');
                    isValid = false;
                } else {
                    error.classList.remove('visible');
                }
            });
            
            // Consent must be "Yes"
            const consent = document.querySelector('input[name="consent"]:checked');
            if (consent && consent.value === 'No') {
                document.getElementById('consentError').classList.add('visible');
                document.getElementById('consentError').textContent = 'You must consent to proceed';
                isValid = false;
            }
            
            // Validate injury details if injured is Yes
            const injured = document.querySelector('input[name="injured"]:checked');
            if (injured && injured.value === 'Yes') {
                const injuryDescription = document.getElementById('injuryDescription');
                const injuryLocation = document.getElementById('injuryLocation');
                
                if (!injuryDescription.value.trim()) {
                    injuryDescription.classList.add('error');
                    document.getElementById('injuryDescriptionError').classList.add('visible');
                    isValid = false;
                } else {
                    injuryDescription.classList.remove('error');
                    document.getElementById('injuryDescriptionError').classList.remove('visible');
                }
                
                if (!injuryLocation.value.trim()) {
                    injuryLocation.classList.add('error');
                    document.getElementById('injuryLocationError').classList.add('visible');
                    isValid = false;
                } else {
                    injuryLocation.classList.remove('error');
                    document.getElementById('injuryLocationError').classList.remove('visible');
                }
            }
            
            // File upload
            const photoId = document.getElementById('photoId');
            if (!photoId.files || !photoId.files[0]) {
                document.getElementById('photoIdError').classList.add('visible');
                isValid = false;
            } else {
                document.getElementById('photoIdError').classList.remove('visible');
            }
            
            // Signature
            if (signaturePad.isEmpty()) {
                document.getElementById('signatureError').classList.add('visible');
                isValid = false;
            } else {
                document.getElementById('signatureError').classList.remove('visible');
            }
            
            // Conditional required fields
            const onMeds = document.querySelector('input[name="onMedications"]:checked');
            if (onMeds && onMeds.value === 'Yes') {
                const currentMeds = document.getElementById('currentMedications');
                if (!currentMeds.value.trim()) {
                    currentMeds.classList.add('error');
                    isValid = false;
                }
            }
            
            const hasAllergies = document.querySelector('input[name="hasAllergies"]:checked');
            if (hasAllergies && hasAllergies.value === 'Yes') {
                const allergies = document.getElementById('allergies');
                if (!allergies.value.trim()) {
                    allergies.classList.add('error');
                    isValid = false;
                }
            }
            
            return isValid;
        }
        
        // ============================================
        // COLLECT FORM DATA
        // ============================================
        
        async function collectFormData() {
            const getValue = (id) => document.getElementById(id)?.value || '';
            const getRadio = (name) => document.querySelector(`input[name="${name}"]:checked`)?.value || '';
            
            // Collect condition details with YES/NO radio buttons
            const conditionsList = [];
            const conditionNames = ['hypertension', 'highCholesterol', 'heartDisease', 
                                   'diabetes', 'thyroid', 'depression', 
                                   'kidney', 'liver', 'autoimmune', 'cancer'];
            
            const conditionLabels = {
                'hypertension': 'High Blood Pressure (Hypertension)',
                'highCholesterol': 'High Cholesterol',
                'heartDisease': 'Heart Disease',
                'diabetes': 'Diabetes',
                'thyroid': 'Thyroid Disorder',
                'depression': 'Depression / Anxiety',
                'kidney': 'Kidney Disease',
                'liver': 'Liver Disease',
                'autoimmune': 'Autoimmune Disorder',
                'cancer': 'Cancer'
            };
            
            // Collect individual condition responses (all Yes/No answers)
            const medicalHistory = {};
            conditionNames.forEach(conditionName => {
                const response = getRadio(conditionName);
                medicalHistory[conditionName] = {
                    response: response,
                    label: conditionLabels[conditionName]
                };
                
                if (response === 'Yes') {
                    const yearEl = document.getElementById(conditionName + '-year');
                    const typeEl = document.getElementById(conditionName + '-type');
                    
                    if (typeEl && typeEl.value) {
                        medicalHistory[conditionName].type = typeEl.value;
                    }
                    if (yearEl && yearEl.value) {
                        medicalHistory[conditionName].year = yearEl.value;
                    }
                    
                    // Also build the summary string
                    let conditionInfo = conditionLabels[conditionName];
                    if (typeEl && typeEl.value) {
                        conditionInfo += ` (Type: ${typeEl.value}`;
                        if (yearEl && yearEl.value) {
                            conditionInfo += `, Diagnosed: ${yearEl.value})`;
                        } else {
                            conditionInfo += ')';
                        }
                    } else if (yearEl && yearEl.value) {
                        conditionInfo += ` (Diagnosed: ${yearEl.value})`;
                    }
                    conditionsList.push(conditionInfo);
                }
            });
            
            const conditions = conditionsList.length > 0 ? conditionsList.join('; ') : 'None';
            
            // Get photo ID as base64
            let photoIdBase64 = null;
            const photoIdInput = document.getElementById('photoId');
            if (photoIdInput.files && photoIdInput.files[0]) {
                const file = photoIdInput.files[0];
                photoIdBase64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(file);
                });
            }
            
            return {
                // Personal Info
                firstName: getValue('firstName'),
                lastName: getValue('lastName'),
                gender: getValue('gender'),
                dateOfBirth: getValue('dob'),
                email: getValue('email'),
                phone: getValue('phone'),
                
                // Address
                streetAddress: getValue('streetAddress'),
                city: getValue('city'),
                state: getValue('state'),
                country: getValue('country'),
                postalCode: getValue('postalCode'),
                
                // Health Concerns
                whatBringsYou: getValue('whatBringsYou'),
                injured: getRadio('injured'),
                injuryDescription: getValue('injuryDescription'),
                injuryLocation: getValue('injuryLocation'),
                injuryDate: getValue('injuryDate'),
                
                // Medical History - now includes detailed info
                conditions: conditions,
                medicalHistory: medicalHistory, // Individual responses
                
                // Medications & Allergies
                onHRT: getRadio('onHRT'),
                hrtDetails: getValue('hrtDetails'),
                onMedications: getRadio('onMedications'),
                currentMedications: getValue('currentMedications'),
                medicationNotes: getValue('medicationNotes'),
                hasAllergies: getRadio('hasAllergies'),
                allergies: getValue('allergies'),
                allergyReactions: getValue('allergyReactions'),
                
                // Guardian
                guardianName: getValue('guardianName'),
                
                // Photo ID
                photoId: photoIdBase64,
                
                // Consent
                consent: getRadio('consent'),
                
                // Metadata
                submissionDate: new Date().toLocaleString(),
                signature: signaturePad.toDataURL()
            };
        }
        
        // ============================================
        // GENERATE PDF
        // ============================================
        
        async function generatePDF(formData) {
            // Access jsPDF - handle different loading methods
            let jsPDF;
            if (window.jspdf && window.jspdf.jsPDF) {
                jsPDF = window.jspdf.jsPDF;
            } else if (window.jsPDF) {
                jsPDF = window.jsPDF;
            } else {
                throw new Error('jsPDF library not loaded');
            }
            
            // Create compressed PDF
            const doc = new jsPDF({
                compress: true
            });
            
            let yPos = 20;
            const leftMargin = 20;
            const pageWidth = doc.internal.pageSize.getWidth();
            const contentWidth = pageWidth - 40;
            
            // Helper function to add text and move position
            function addText(text, fontSize = 11, isBold = false) {
                doc.setFontSize(fontSize);
                doc.setFont('helvetica', isBold ? 'bold' : 'normal');
                
                // Handle long text with word wrap
                const safeText = String(text || '');
                const lines = doc.splitTextToSize(safeText, contentWidth);
                doc.text(lines, leftMargin, yPos);
                yPos += (lines.length * fontSize * 0.4) + 2;
                
                // Check if we need a new page
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }
            }
            
            function addLabelValue(label, value) {
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text(label, leftMargin, yPos);
                doc.setFont('helvetica', 'normal');
                
                const labelWidth = doc.getTextWidth(label) + 2;
                const safeValue = String(value || 'N/A');
                const valueLines = doc.splitTextToSize(safeValue, contentWidth - labelWidth - 10);
                doc.text(valueLines, leftMargin + labelWidth, yPos);
                yPos += (valueLines.length * 5) + 3;
                
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }
            }
            
            function addSectionHeader(text) {
                yPos += 5;
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text(text, leftMargin, yPos);
                yPos += 2;
                doc.setLineWidth(0.5);
                doc.line(leftMargin, yPos, pageWidth - leftMargin, yPos);
                yPos += 8;
            }
            
            function addSpace(space = 5) {
                yPos += space;
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }
            }
            
            // === HEADER ===
            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.text('RANGE MEDICAL', pageWidth / 2, yPos, { align: 'center' });
            yPos += 8;
            
            doc.setFontSize(14);
            doc.setFont('helvetica', 'normal');
            doc.text('New Patient Medical Intake Form', pageWidth / 2, yPos, { align: 'center' });
            yPos += 6;
            
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text('Submitted: ' + formData.submissionDate, pageWidth / 2, yPos, { align: 'center' });
            doc.setTextColor(0);
            yPos += 5;
            
            doc.setLineWidth(1);
            doc.line(leftMargin, yPos, pageWidth - leftMargin, yPos);
            yPos += 10;
            
            // === PERSONAL INFORMATION ===
            addSectionHeader('PERSONAL INFORMATION');
            addLabelValue('Name: ', formData.firstName + ' ' + formData.lastName);
            addLabelValue('Gender: ', formData.gender);
            addLabelValue('Date of Birth: ', formData.dateOfBirth);
            addLabelValue('Email: ', formData.email);
            addLabelValue('Phone: ', formData.phone);
            
            // === ADDRESS ===
            addSectionHeader('ADDRESS');
            addText(formData.streetAddress);
            addText(formData.city + ', ' + formData.state + ' ' + formData.postalCode);
            addText(formData.country);
            
            // === HEALTH CONCERNS ===
            addSectionHeader('HEALTH CONCERNS & SYMPTOMS');
            addLabelValue('What Brings You In: ', formData.whatBringsYou);
            addLabelValue('Currently Injured: ', formData.injured);
            
            if (formData.injured === 'Yes') {
                addLabelValue('Injury Description: ', formData.injuryDescription);
                addLabelValue('Injury Location: ', formData.injuryLocation);
                if (formData.injuryDate) {
                    addLabelValue('When It Occurred: ', formData.injuryDate);
                }
            }
            
            // === MEDICAL HISTORY ===
            addSectionHeader('MEDICAL HISTORY');
            
            // Show all conditions organized by category
            if (formData.medicalHistory) {
                const mh = formData.medicalHistory;
                
                // Cardiovascular
                addText('CARDIOVASCULAR CONDITIONS:', 11, true);
                ['hypertension', 'highCholesterol', 'heartDisease'].forEach(condition => {
                    if (mh[condition]) {
                        let text = `  ${mh[condition].label}: ${mh[condition].response}`;
                        if (mh[condition].response === 'Yes') {
                            if (mh[condition].type) text += ` (Type: ${mh[condition].type})`;
                            if (mh[condition].year) text += ` [${mh[condition].year}]`;
                        }
                        addText(text, 10);
                    }
                });
                addText('', 10); // spacing
                
                // Metabolic & Endocrine
                addText('METABOLIC & ENDOCRINE CONDITIONS:', 11, true);
                ['diabetes', 'thyroid'].forEach(condition => {
                    if (mh[condition]) {
                        let text = `  ${mh[condition].label}: ${mh[condition].response}`;
                        if (mh[condition].response === 'Yes') {
                            if (mh[condition].type) text += ` (Type: ${mh[condition].type})`;
                            if (mh[condition].year) text += ` [${mh[condition].year}]`;
                        }
                        addText(text, 10);
                    }
                });
                addText('', 10); // spacing
                
                // Mental Health
                addText('MENTAL HEALTH CONDITIONS:', 11, true);
                if (mh['depression']) {
                    let text = `  ${mh['depression'].label}: ${mh['depression'].response}`;
                    if (mh['depression'].response === 'Yes' && mh['depression'].year) {
                        text += ` [${mh['depression'].year}]`;
                    }
                    addText(text, 10);
                }
                addText('', 10); // spacing
                
                // Organ Health
                addText('ORGAN HEALTH CONDITIONS:', 11, true);
                ['kidney', 'liver'].forEach(condition => {
                    if (mh[condition]) {
                        let text = `  ${mh[condition].label}: ${mh[condition].response}`;
                        if (mh[condition].response === 'Yes') {
                            if (mh[condition].type) text += ` (Type: ${mh[condition].type})`;
                            if (mh[condition].year) text += ` [${mh[condition].year}]`;
                        }
                        addText(text, 10);
                    }
                });
                addText('', 10); // spacing
                
                // Immune System & Cancer
                addText('IMMUNE SYSTEM & CANCER:', 11, true);
                ['autoimmune', 'cancer'].forEach(condition => {
                    if (mh[condition]) {
                        let text = `  ${mh[condition].label}: ${mh[condition].response}`;
                        if (mh[condition].response === 'Yes') {
                            if (mh[condition].type) text += ` (Type: ${mh[condition].type})`;
                            if (mh[condition].year) text += ` [${mh[condition].year}]`;
                        }
                        addText(text, 10);
                    }
                });
            } else {
                // Fallback to old format if medicalHistory not available
                addLabelValue('Diagnosed Conditions: ', formData.conditions);
            }
            
            addText('', 10); // spacing
            
            // === MEDICATIONS & ALLERGIES ===
            addSectionHeader('MEDICATIONS & ALLERGIES');
            
            // HRT Section
            addLabelValue('On HRT: ', formData.onHRT || 'Not specified');
            if (formData.onHRT === 'Yes' && formData.hrtDetails) {
                addLabelValue('HRT Details: ', formData.hrtDetails);
            }
            
            addLabelValue('On Other Medications: ', formData.onMedications);
            
            if (formData.onMedications === 'Yes') {
                addLabelValue('Current Medications: ', formData.currentMedications);
                if (formData.medicationNotes) {
                    addLabelValue('Medication Notes: ', formData.medicationNotes);
                }
            }
            
            addLabelValue('Has Allergies: ', formData.hasAllergies);
            
            if (formData.hasAllergies === 'Yes') {
                addLabelValue('Allergies: ', formData.allergies);
                if (formData.allergyReactions) {
                    addLabelValue('Allergy Reactions: ', formData.allergyReactions);
                }
            }
            
            // === GUARDIAN INFO ===
            if (formData.guardianName) {
                addSectionHeader('GUARDIAN INFORMATION');
                addLabelValue('Parent/Guardian Name: ', formData.guardianName);
            }
            
            // === PHOTO ID ===
            if (formData.photoId) {
                addSectionHeader('PHOTO IDENTIFICATION');
                
                try {
                    // Compress the ID image
                    const img = new Image();
                    await new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = reject;
                        img.src = formData.photoId;
                    });
                    
                    // Calculate dimensions to fit in PDF (max width 150mm, max height 80mm)
                    const maxWidth = 150;
                    const maxHeight = 80;
                    let width = img.width;
                    let height = img.height;
                    
                    // Scale down to fit
                    if (width > maxWidth) {
                        height = height * (maxWidth / width);
                        width = maxWidth;
                    }
                    if (height > maxHeight) {
                        width = width * (maxHeight / height);
                        height = maxHeight;
                    }
                    
                    // Create compressed version
                    const canvas = document.createElement('canvas');
                    canvas.width = width * 2; // Higher res for quality
                    canvas.height = height * 2;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    const compressedId = canvas.toDataURL('image/jpeg', 0.6);
                    
                    // Check if we need a new page
                    if (yPos + height > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.addImage(compressedId, 'JPEG', leftMargin, yPos, width * 0.5, height * 0.5);
                    yPos += (height * 0.5) + 10;
                } catch (e) {
                    console.log('ID image error:', e);
                    doc.setFont('helvetica', 'italic');
                    doc.text('[Photo ID uploaded but could not be rendered]', leftMargin, yPos);
                    yPos += 8;
                }
            }
            
            // === CONSENT ===
            addSectionHeader('CONSENT & SIGNATURE');
            
            doc.setFontSize(9);
            doc.setFont('helvetica', 'italic');
            const consentText = 'I consent to evaluation and wellness services provided by Range Medical staff under the supervision of the medical director. I understand some therapies may be used off-label and that individual results can vary. I authorize Range Medical to contact me via the methods provided above. I acknowledge responsibility for payment for services rendered and have reviewed any posted cancellation/no-show policies.';
            const consentLines = doc.splitTextToSize(consentText, contentWidth);
            doc.text(consentLines, leftMargin, yPos);
            yPos += (consentLines.length * 4) + 5;
            
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            addLabelValue('Consent Given: ', formData.consent);
            
            addSpace(3);
            doc.setFont('helvetica', 'bold');
            doc.text('Patient/Guardian Signature:', leftMargin, yPos);
            yPos += 5;
            
            // Add signature image - compress it to reduce size
            if (formData.signature && formData.signature.startsWith('data:image')) {
                try {
                    // Compress signature by creating smaller canvas
                    const img = new Image();
                    await new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = reject;
                        img.src = formData.signature;
                    });
                    
                    // Create smaller canvas for signature
                    const canvas = document.createElement('canvas');
                    const maxWidth = 200;
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // Get compressed image as JPEG with lower quality
                    const compressedSignature = canvas.toDataURL('image/jpeg', 0.5);
                    
                    doc.addImage(compressedSignature, 'JPEG', leftMargin, yPos, 50, 15);
                    yPos += 20;
                } catch (e) {
                    console.log('Signature compression error:', e);
                    doc.setFont('helvetica', 'italic');
                    doc.text('[Signature captured electronically]', leftMargin, yPos);
                    yPos += 8;
                }
            }
            
            // === FOOTER ===
            addSpace(10);
            doc.setLineWidth(1);
            doc.line(leftMargin, yPos, pageWidth - leftMargin, yPos);
            yPos += 8;
            
            doc.setFontSize(9);
            doc.setTextColor(100);
            doc.setFont('helvetica', 'normal');
            doc.text('This document was electronically generated and submitted via the Range Medical patient portal.', pageWidth / 2, yPos, { align: 'center' });
            yPos += 5;
            doc.text('¬© 2025 Range Medical. All rights reserved. | Confidential Patient Information', pageWidth / 2, yPos, { align: 'center' });
            
            // Return as blob
            return doc.output('blob');
        }
        
        // ============================================
        // SUPABASE INITIALIZATION
        // ============================================
        
        const supabaseClient = supabase.createClient(
            CONFIG.supabase.url,
            CONFIG.supabase.anonKey
        );
        
        // ============================================
        // UPLOAD PDF TO SUPABASE STORAGE
        // ============================================
        
        async function uploadPDFToStorage(pdfBlob, formData) {
            try {
                const timestamp = Date.now();
                const fileName = `intake-${formData.firstName}-${formData.lastName}-${timestamp}.pdf`;
                const filePath = `medical-intake/${fileName}`;
                
                console.log('Uploading PDF to Supabase:', filePath);
                
                const { data, error } = await supabaseClient.storage
                    .from('medical-documents')
                    .upload(filePath, pdfBlob, {
                        contentType: 'application/pdf',
                        cacheControl: '3600',
                        upsert: false
                    });
                
                if (error) {
                    console.error('Supabase upload error:', error);
                    throw error;
                }
                
                // Get public URL
                const { data: { publicUrl } } = supabaseClient.storage
                    .from('medical-documents')
                    .getPublicUrl(filePath);
                
                console.log('PDF uploaded successfully:', publicUrl);
                return publicUrl;
            } catch (error) {
                console.error('Error uploading PDF:', error);
                throw error;
            }
        }
        
        // ============================================
        // SEND DATA TO GOHIGHLEVEL
        // ============================================
        
        async function sendToGoHighLevel(formData, pdfUrl) {
            try {
                console.log('Sending data to GoHighLevel...');
                
                const response = await fetch('/api/intake-to-ghl', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        firstName: formData.firstName,
                        lastName: formData.lastName,
                        email: formData.email,
                        phone: formData.phone,
                        dateOfBirth: formData.dob,
                        address: formData.address,
                        city: formData.city,
                        state: formData.state,
                        zipCode: formData.zip,
                        country: 'US',
                        pdfUrl: pdfUrl
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ Successfully sent to GoHighLevel');
                    console.log('Contact ID:', result.contactId);
                } else {
                    console.error('‚ùå Failed to send to GoHighLevel:', result.error);
                }
                
                return result;
            } catch (error) {
                console.error('Error sending to GoHighLevel:', error);
                // Don't throw - we don't want to fail the whole submission if GHL fails
                return { success: false, error: error.message };
            }
        }
        
        // ============================================
        // SEND EMAIL WITH FORM DATA
        // ============================================
        
        async function sendEmail(formData, pdfBlob) {
            // Initialize EmailJS
            emailjs.init(CONFIG.emailjs.publicKey);
            
            // Convert PDF blob to base64
            const base64PDF = await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(pdfBlob);
            });
            
            // Build comprehensive message with all form data
            let messageBody = `
NEW PATIENT INTAKE FORM SUBMISSION
==================================

PERSONAL INFORMATION
--------------------
Name: ${formData.firstName} ${formData.lastName}
Gender: ${formData.gender}
Date of Birth: ${formData.dateOfBirth}
Email: ${formData.email}
Phone: ${formData.phone}

ADDRESS
-------
${formData.streetAddress}
${formData.city}, ${formData.state} ${formData.postalCode}
${formData.country}

HEALTH CONCERNS & SYMPTOMS
--------------------------
What Brings You In: ${formData.whatBringsYou}
Currently Injured: ${formData.injured}`;

            if (formData.injured === 'Yes') {
                messageBody += `
Injury Description: ${formData.injuryDescription}
Injury Location: ${formData.injuryLocation}
When It Occurred: ${formData.injuryDate || 'Not specified'}`;
            }

            messageBody += `

MEDICAL HISTORY
---------------`;

            // Show all conditions organized by category
            if (formData.medicalHistory) {
                const mh = formData.medicalHistory;
                
                messageBody += `

‚ù§Ô∏è CARDIOVASCULAR CONDITIONS:`;
                ['hypertension', 'highCholesterol', 'heartDisease'].forEach(condition => {
                    if (mh[condition]) {
                        let text = `${mh[condition].label}: ${mh[condition].response}`;
                        if (mh[condition].response === 'Yes') {
                            if (mh[condition].type) text += ` (Type: ${mh[condition].type})`;
                            if (mh[condition].year) text += ` [Diagnosed: ${mh[condition].year}]`;
                        }
                        messageBody += `
  ‚Ä¢ ${text}`;
                    }
                });
                
                messageBody += `

‚ö° METABOLIC & ENDOCRINE CONDITIONS:`;
                ['diabetes', 'thyroid'].forEach(condition => {
                    if (mh[condition]) {
                        let text = `${mh[condition].label}: ${mh[condition].response}`;
                        if (mh[condition].response === 'Yes') {
                            if (mh[condition].type) text += ` (Type: ${mh[condition].type})`;
                            if (mh[condition].year) text += ` [Diagnosed: ${mh[condition].year}]`;
                        }
                        messageBody += `
  ‚Ä¢ ${text}`;
                    }
                });
                
                messageBody += `

üß† MENTAL HEALTH CONDITIONS:`;
                if (mh['depression']) {
                    let text = `${mh['depression'].label}: ${mh['depression'].response}`;
                    if (mh['depression'].response === 'Yes' && mh['depression'].year) {
                        text += ` [Diagnosed: ${mh['depression'].year}]`;
                    }
                    messageBody += `
  ‚Ä¢ ${text}`;
                }
                
                messageBody += `

ü´Å ORGAN HEALTH CONDITIONS:`;
                ['kidney', 'liver'].forEach(condition => {
                    if (mh[condition]) {
                        let text = `${mh[condition].label}: ${mh[condition].response}`;
                        if (mh[condition].response === 'Yes') {
                            if (mh[condition].type) text += ` (Type: ${mh[condition].type})`;
                            if (mh[condition].year) text += ` [Diagnosed: ${mh[condition].year}]`;
                        }
                        messageBody += `
  ‚Ä¢ ${text}`;
                    }
                });
                
                messageBody += `

üõ°Ô∏è IMMUNE SYSTEM & CANCER:`;
                ['autoimmune', 'cancer'].forEach(condition => {
                    if (mh[condition]) {
                        let text = `${mh[condition].label}: ${mh[condition].response}`;
                        if (mh[condition].response === 'Yes') {
                            if (mh[condition].type) text += ` (Type: ${mh[condition].type})`;
                            if (mh[condition].year) text += ` [Diagnosed: ${mh[condition].year}]`;
                        }
                        messageBody += `
  ‚Ä¢ ${text}`;
                    }
                });
            } else {
                // Fallback to old format
                messageBody += `
Diagnosed Conditions: ${formData.conditions}`;
            }

            messageBody += `

MEDICATIONS & ALLERGIES
-----------------------
On HRT: ${formData.onHRT || 'Not specified'}`;

            if (formData.onHRT === 'Yes' && formData.hrtDetails) {
                messageBody += `
HRT Details: ${formData.hrtDetails}`;
            }

            messageBody += `
On Other Medications: ${formData.onMedications}`;

            if (formData.onMedications === 'Yes') {
                messageBody += `
Current Medications: ${formData.currentMedications}`;
                if (formData.medicationNotes) {
                    messageBody += `
Medication Notes: ${formData.medicationNotes}`;
                }
            }

            messageBody += `
Has Allergies: ${formData.hasAllergies}`;

            if (formData.hasAllergies === 'Yes') {
                messageBody += `
Allergies: ${formData.allergies}`;
                if (formData.allergyReactions) {
                    messageBody += `
Allergy Reactions: ${formData.allergyReactions}`;
                }
            }

            if (formData.guardianName) {
                messageBody += `

GUARDIAN INFORMATION
--------------------
Parent/Guardian Name: ${formData.guardianName}`;
            }

            messageBody += `

CONSENT
-------
Consent Given: ${formData.consent}
Signature: Provided electronically
Photo ID: ${formData.photoId ? 'Included in attached PDF' : 'Not provided'}
Submitted: ${formData.submissionDate}

==================================
PDF intake form is attached to this email.
`;
            
            // Send email with PDF attachment
            const templateParams = {
                to_email: CONFIG.recipientEmail,
                from_name: `${formData.firstName} ${formData.lastName}`,
                patient_name: `${formData.firstName} ${formData.lastName}`,
                patient_email: formData.email,
                patient_phone: formData.phone,
                submission_date: formData.submissionDate,
                message: messageBody,
                // PDF attachment
                content: base64PDF,
                filename: `RangeMedical_Intake_${formData.lastName}_${formData.firstName}.pdf`
            };
            
            console.log('Sending email with params:', Object.keys(templateParams));
            console.log('PDF base64 length:', base64PDF.length);
            console.log('Estimated PDF size:', Math.round(base64PDF.length * 0.75 / 1024), 'KB');
            
            try {
                const response = await emailjs.send(
                    CONFIG.emailjs.serviceId,
                    CONFIG.emailjs.templateId,
                    templateParams
                );
                console.log('EmailJS response:', response);
                return response;
            } catch (emailError) {
                console.error('EmailJS error object:', emailError);
                // Extract meaningful error message
                const errorMsg = emailError.text || emailError.message || JSON.stringify(emailError);
                throw new Error(errorMsg);
            }
        }
        
        // ============================================
        // FORM SUBMISSION
        // ============================================
        
        document.getElementById('intakeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validate
            if (!validateForm()) {
                showStatus('Please fill in all required fields correctly.', 'error');
                // Scroll to first error
                const firstError = document.querySelector('.field-error.visible');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            showStatus('Submitting your form...', 'loading');
            
            try {
                // Collect form data
                showStatus('Collecting form data...', 'loading');
                const formData = await collectFormData();
                console.log('Form data collected:', formData);
                
                // Generate PDF
                showStatus('Generating PDF...', 'loading');
                let pdfBlob;
                try {
                    pdfBlob = await generatePDF(formData);
                    console.log('PDF generated:', pdfBlob);
                } catch (pdfError) {
                    console.error('PDF generation failed:', pdfError);
                    throw new Error('PDF generation failed: ' + (pdfError.message || pdfError));
                }
                
                // Send email notification to Range Medical with PDF attachment
                showStatus('Sending to Range Medical...', 'loading');
                try {
                    await sendEmail(formData, pdfBlob);
                    console.log('Email sent successfully');
                } catch (emailError) {
                    console.error('Email sending failed:', emailError);
                    throw new Error('Email sending failed: ' + (emailError.message || emailError));
                }
                
                // Upload PDF to Supabase and send to GoHighLevel
                showStatus('Uploading PDF and syncing to GoHighLevel...', 'loading');
                let pdfUrl = null;
                try {
                    // Upload PDF to Supabase
                    pdfUrl = await uploadPDFToStorage(pdfBlob, formData);
                    console.log('PDF uploaded to storage:', pdfUrl);
                    
                    // Send to GoHighLevel
                    const ghlResult = await sendToGoHighLevel(formData, pdfUrl);
                    if (ghlResult.success) {
                        console.log('‚úÖ GoHighLevel sync successful');
                    } else {
                        console.warn('‚ö†Ô∏è GoHighLevel sync failed (non-critical):', ghlResult.error);
                    }
                } catch (storageError) {
                    // Don't fail the whole submission if storage/GHL fails
                    console.error('Storage/GHL error (non-critical):', storageError);
                    console.warn('‚ö†Ô∏è Continuing despite storage/GHL error');
                }
                
                // Show thank you page
                showThankYouPage(formData);
                
            } catch (error) {
                console.error('Submission error:', error);
                console.error('Error details:', error.message, error.stack);
                showStatus('Error: ' + (error.message || 'Unknown error occurred'), 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Intake Form';
            }
        });
        
        function showThankYouPage(formData) {
            // Replace form with thank you message
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div class="thank-you-page">
                    <div class="thank-you-icon">‚úì</div>
                    <h1>Thank You, ${formData.firstName}!</h1>
                    <p class="thank-you-subtitle">Your intake form has been successfully submitted.</p>
                    
                    <div class="thank-you-details">
                        <p>We've received your information and our team will review it before your appointment.</p>
                        <p>A confirmation has been sent to our office.</p>
                    </div>
                    
                    <div class="thank-you-contact">
                        <h3>Questions?</h3>
                        <p>Contact us at <a href="mailto:info@range-medical.com">info@range-medical.com</a></p>
                    </div>
                    
                    <div class="thank-you-footer">
                        <p>RANGE MEDICAL</p>
                    </div>
                </div>
            `;
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = 'status-message visible ' + type;
        }
    </script>
</body>
</html>
