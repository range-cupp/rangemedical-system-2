<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Patient Medical Intake | Range Medical</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
        :root{--black:#000;--white:#fff;--gray-50:#fafafa;--gray-100:#f5f5f5;--gray-200:#e5e5e5;--gray-300:#d4d4d4;--gray-400:#a3a3a3;--gray-500:#737373;--gray-600:#525252;--gray-700:#404040;--gray-800:#262626;--gray-900:#171717;--error:#dc2626;--success:#16a34a}
        html{font-size:16px}
        body{font-family:'DM Sans',-apple-system,BlinkMacSystemFont,sans-serif;background-color:var(--gray-100);color:var(--gray-900);line-height:1.6;min-height:100vh}
        .container{max-width:800px;margin:0 auto;padding:2rem 1.5rem}
        .header{text-align:center;margin-bottom:2.5rem;padding-bottom:2rem;border-bottom:2px solid var(--black)}
        .clinic-name{font-size:2.5rem;font-weight:700;letter-spacing:.15em;margin-bottom:.5rem;color:var(--black)}
        .form-title{font-size:1.25rem;font-weight:600;letter-spacing:.05em;text-transform:uppercase;margin-top:.5rem;color:var(--gray-700)}
        .header p{color:var(--gray-600);font-size:.875rem;margin-top:.5rem}
        .form-container{background:var(--white);border:2px solid var(--black);padding:2rem}
        .section{margin-bottom:2.5rem;padding-bottom:2rem;border-bottom:1px solid var(--gray-200)}
        .section:last-of-type{border-bottom:none;margin-bottom:0;padding-bottom:0}
        .section-title{font-size:1.125rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;margin-bottom:1.5rem;padding-bottom:.75rem;border-bottom:2px solid var(--black);display:inline-block}
        .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.25rem;margin-bottom:1.25rem}
        .form-row:last-child{margin-bottom:0}
        .form-group{display:flex;flex-direction:column}
        .form-group.full-width{grid-column:1/-1}
        label{font-size:.8125rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-bottom:.5rem;color:var(--gray-700)}
        label .required{color:var(--error);margin-left:2px}
        input[type="text"],input[type="email"],input[type="tel"],input[type="date"],select,textarea{width:100%;padding:.75rem 1rem;font-size:1rem;font-family:inherit;border:1.5px solid var(--gray-300);background:var(--white);color:var(--gray-900);transition:border-color .2s ease,box-shadow .2s ease}
        input:focus,select:focus,textarea:focus{outline:none;border-color:var(--black);box-shadow:0 0 0 3px rgba(0,0,0,.1)}
        input.error,select.error,textarea.error{border-color:var(--error)}
        textarea{resize:vertical;min-height:100px}
        select{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23525252' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 1rem center;padding-right:2.5rem}
        .radio-group{display:flex;gap:1.5rem;flex-wrap:wrap}
        .radio-item{display:flex;align-items:center;gap:.5rem;cursor:pointer}
        .radio-item input[type="radio"]{width:1.25rem;height:1.25rem;cursor:pointer;accent-color:var(--black)}
        .radio-item label{font-size:.9375rem;font-weight:500;text-transform:none;letter-spacing:normal;margin-bottom:0;cursor:pointer;color:var(--gray-800)}
        .conditional-field{display:none;margin-top:1rem;padding-left:1.75rem;border-left:3px solid var(--gray-300)}
        .conditional-field.visible{display:block}
        .condition-item{margin-bottom:.75rem;padding-bottom:.75rem;border-bottom:1px solid var(--gray-100)}
        .condition-item:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
        .condition-details{display:none;margin-top:.75rem;margin-left:1.75rem;padding:1rem;background:var(--gray-50);border-left:3px solid var(--gray-300)}
        .file-upload{position:relative}
        .file-upload-input{position:absolute;width:100%;height:100%;opacity:0;cursor:pointer}
        .file-upload-label{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2rem;border:2px dashed var(--gray-300);background:var(--gray-50);text-align:center;cursor:pointer;transition:border-color .2s ease,background-color .2s ease}
        .file-upload-label:hover{border-color:var(--black);background:var(--gray-100)}
        .file-upload-icon{font-size:2rem;margin-bottom:.5rem}
        .file-upload-text{font-size:.875rem;color:var(--gray-600)}
        .file-preview{margin-top:1rem;display:none}
        .file-preview.visible{display:block}
        .file-preview img{max-width:200px;max-height:150px;border:1px solid var(--gray-300)}
        .signature-container{border:1.5px solid var(--gray-300);background:var(--white)}
        .signature-pad{width:100%;height:150px;display:block}
        .signature-actions{display:flex;gap:1rem;margin-top:.75rem}
        .btn-clear{padding:.5rem 1rem;font-size:.875rem;font-weight:600;background:var(--white);border:1.5px solid var(--gray-400);cursor:pointer;transition:all .2s ease}
        .btn-clear:hover{border-color:var(--black);background:var(--gray-100)}
        .consent-box{background:var(--gray-50);border:1px solid var(--gray-200);padding:1.5rem;margin-bottom:1.5rem}
        .consent-text{font-size:.9375rem;line-height:1.7;color:var(--gray-700);margin-bottom:1rem}
        .submit-section{margin-top:2.5rem;padding-top:2rem;border-top:2px solid var(--black)}
        .btn-submit{width:100%;padding:1.25rem 2rem;font-size:1.125rem;font-weight:700;font-family:inherit;text-transform:uppercase;letter-spacing:.1em;background:var(--black);color:var(--white);border:none;cursor:pointer;transition:all .2s ease}
        .btn-submit:hover{background:var(--gray-800);transform:translateY(-1px)}
        .btn-submit:disabled{background:var(--gray-400);cursor:not-allowed;transform:none}
        .status-message{padding:1rem;margin-top:1rem;text-align:center;font-weight:600;display:none}
        .status-message.visible{display:block}
        .status-message.success{background:#dcfce7;color:var(--success);border:1px solid var(--success)}
        .status-message.error{background:#fee2e2;color:var(--error);border:1px solid var(--error)}
        .status-message.loading{background:var(--gray-100);color:var(--gray-700);border:1px solid var(--gray-300)}
        .field-error{font-size:.8125rem;color:var(--error);margin-top:.375rem;display:none}
        .field-error.visible{display:block}
        .footer{text-align:center;margin-top:2rem;padding-top:1.5rem;font-size:.8125rem;color:var(--gray-500)}
        .thank-you-page{background:var(--white);border:2px solid var(--black);padding:3rem 2rem;text-align:center;max-width:600px;margin:2rem auto}
        .thank-you-icon{width:80px;height:80px;background:var(--black);color:var(--white);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2.5rem;margin:0 auto 1.5rem auto}
        .thank-you-page h1{font-size:2rem;font-weight:700;margin-bottom:.5rem;color:var(--black)}
        .thank-you-subtitle{font-size:1.125rem;color:var(--gray-600);margin-bottom:2rem}
        .thank-you-details{background:var(--gray-50);padding:1.5rem;margin-bottom:2rem;border-left:4px solid var(--black);text-align:left}
        .thank-you-details p{margin-bottom:.75rem;color:var(--gray-700)}
        .thank-you-details p:last-child{margin-bottom:0}
        .thank-you-footer{padding-top:1.5rem;border-top:1px solid var(--gray-200)}
        .thank-you-footer p{font-size:1.25rem;font-weight:700;letter-spacing:.1em;color:var(--black)}
        .field-hint{font-size:.75rem;font-weight:400;color:var(--gray-500);text-transform:none;letter-spacing:normal;margin-top:.25rem}
        @media(max-width:600px){.container{padding:1rem}.form-container{padding:1.5rem}.form-row{grid-template-columns:1fr}.radio-group{flex-direction:column;gap:.75rem}}
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="clinic-name">RANGE MEDICAL</h1>
            <h2 class="form-title">New Patient Medical Intake Form</h2>
            <p>Please complete all required fields marked with *</p>
        </header>
        <div class="form-container">
            <form id="intakeForm" novalidate>
                <!-- Personal Information -->
                <div class="section">
                    <h2 class="section-title">Personal Information</h2>
                    <div class="form-row">
                        <div class="form-group"><label for="firstName">Legal First Name <span class="required">*</span></label><input type="text" id="firstName" name="firstName" placeholder="As shown on government ID" required><span class="field-error" id="firstNameError">Legal first name is required</span></div>
                        <div class="form-group"><label for="lastName">Legal Last Name <span class="required">*</span></label><input type="text" id="lastName" name="lastName" placeholder="As shown on government ID" required><span class="field-error" id="lastNameError">Legal last name is required</span></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="preferredName">Preferred Name</label><input type="text" id="preferredName" name="preferredName" placeholder="What would you like us to call you?"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="gender">Gender <span class="required">*</span></label><select id="gender" name="gender" required><option value="">Select Gender</option><option value="Male">Male</option><option value="Female">Female</option><option value="Non-binary">Non-binary</option><option value="Prefer not to say">Prefer not to say</option><option value="Other">Other</option></select><span class="field-error" id="genderError">Gender is required</span></div>
                        <div class="form-group"><label for="dob">Date of Birth <span class="required">*</span></label><input type="date" id="dob" name="dob" required><span class="field-error" id="dobError">Date of birth is required</span></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="email">Email <span class="required">*</span></label><input type="email" id="email" name="email" required><span class="field-error" id="emailError">Valid email is required</span></div>
                        <div class="form-group"><label for="phone">Phone <span class="required">*</span></label><input type="tel" id="phone" name="phone" placeholder="(555) 555-5555" required><span class="field-error" id="phoneError">Phone number is required</span></div>
                    </div>
                </div>
                
                <!-- Address -->
                <div class="section">
                    <h2 class="section-title">Address</h2>
                    <div class="form-row"><div class="form-group full-width"><label for="streetAddress">Street Address <span class="required">*</span></label><input type="text" id="streetAddress" name="streetAddress" required><span class="field-error" id="streetAddressError">Street address is required</span></div></div>
                    <div class="form-row">
                        <div class="form-group"><label for="city">City <span class="required">*</span></label><input type="text" id="city" name="city" required><span class="field-error" id="cityError">City is required</span></div>
                        <div class="form-group"><label for="state">State <span class="required">*</span></label><input type="text" id="state" name="state" required><span class="field-error" id="stateError">State is required</span></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="country">Country <span class="required">*</span></label><input type="text" id="country" name="country" value="United States" required><span class="field-error" id="countryError">Country is required</span></div>
                        <div class="form-group"><label for="postalCode">Postal Code <span class="required">*</span></label><input type="text" id="postalCode" name="postalCode" required><span class="field-error" id="postalCodeError">Postal code is required</span></div>
                    </div>
                </div>
                
                <!-- Health Concerns -->
                <div class="section">
                    <h2 class="section-title">Health Concerns & Symptoms</h2>
                    <div class="form-row"><div class="form-group full-width"><label for="whatBringsYou">What Brings You In Today? <span class="required">*</span></label><textarea id="whatBringsYou" name="whatBringsYou" rows="4" placeholder="Please describe your health concerns, symptoms, or wellness goals..." required></textarea><span class="field-error" id="whatBringsYouError">This field is required</span></div></div>
                    <div class="form-row"><div class="form-group full-width"><label>Are you injured? <span class="required">*</span></label><div class="radio-group"><div class="radio-item"><input type="radio" id="injuredYes" name="injured" value="Yes" required><label for="injuredYes">Yes</label></div><div class="radio-item"><input type="radio" id="injuredNo" name="injured" value="No"><label for="injuredNo">No</label></div></div><span class="field-error" id="injuredError">Please select an option</span><div class="conditional-field" id="injuryFields"><div class="form-row"><div class="form-group full-width"><label for="injuryDescription">What is your injury? <span class="required">*</span></label><textarea id="injuryDescription" name="injuryDescription" rows="2" placeholder="Describe your injury..."></textarea><span class="field-error" id="injuryDescriptionError">Please describe your injury</span></div></div><div class="form-row"><div class="form-group"><label for="injuryLocation">Where is it located? <span class="required">*</span></label><input type="text" id="injuryLocation" name="injuryLocation" placeholder="e.g., Lower back, Right knee"><span class="field-error" id="injuryLocationError">Please specify the location</span></div><div class="form-group"><label for="injuryDate">When did it occur?</label><input type="text" id="injuryDate" name="injuryDate" placeholder="e.g., 2 weeks ago"></div></div></div></div></div>
                </div>
                
                <!-- Medical History -->
                <div class="section">
                    <h2 class="section-title">Medical History</h2>
                    <p style="margin-bottom:1.5rem;color:var(--gray-700);font-size:.9375rem">Please answer YES or NO for each condition.</p>
                    
                    <!-- Cardiovascular -->
                    <div style="background-color:#fef2f2;border-left:4px solid #dc2626;padding:1rem;margin-bottom:1.5rem;border-radius:4px">
                        <h3 style="margin:0 0 1rem 0;font-size:.875rem;font-weight:700;text-transform:uppercase;color:#991b1b">‚ù§Ô∏è Cardiovascular</h3>
                        <div class="condition-item"><label><strong>High Blood Pressure</strong> <span class="required">*</span></label><div class="radio-group" style="margin-bottom:.5rem"><div class="radio-item"><input type="radio" id="hypertension_yes" name="hypertension" value="Yes" required class="condition-radio"><label for="hypertension_yes">Yes</label></div><div class="radio-item"><input type="radio" id="hypertension_no" name="hypertension" value="No" class="condition-radio"><label for="hypertension_no">No</label></div></div><div class="condition-details" id="hypertension-details"><div class="form-group"><label for="hypertension-year">Year Diagnosed</label><input type="text" id="hypertension-year" name="hypertensionYear" placeholder="e.g., 2020"></div></div></div>
                        <div class="condition-item"><label><strong>High Cholesterol</strong> <span class="required">*</span></label><div class="radio-group" style="margin-bottom:.5rem"><div class="radio-item"><input type="radio" id="highCholesterol_yes" name="highCholesterol" value="Yes" required class="condition-radio"><label for="highCholesterol_yes">Yes</label></div><div class="radio-item"><input type="radio" id="highCholesterol_no" name="highCholesterol" value="No" class="condition-radio"><label for="highCholesterol_no">No</label></div></div><div class="condition-details" id="highCholesterol-details"><div class="form-group"><label for="highCholesterol-year">Year Diagnosed</label><input type="text" id="highCholesterol-year" name="highCholesterolYear" placeholder="e.g., 2020"></div></div></div>
                        <div class="condition-item"><label><strong>Heart Disease</strong> <span class="required">*</span></label><div class="radio-group" style="margin-bottom:.5rem"><div class="radio-item"><input type="radio" id="heartDisease_yes" name="heartDisease" value="Yes" required class="condition-radio"><label for="heartDisease_yes">Yes</label></div><div class="radio-item"><input type="radio" id="heartDisease_no" name="heartDisease" value="No" class="condition-radio"><label for="heartDisease_no">No</label></div></div><div class="condition-details" id="heartDisease-details"><div class="form-row" style="margin-bottom:0"><div class="form-group"><label for="heartDisease-type">Type</label><input type="text" id="heartDisease-type" name="heartDiseaseType" placeholder="e.g., CHF, CAD"></div><div class="form-group"><label for="heartDisease-year">Year</label><input type="text" id="heartDisease-year" name="heartDiseaseYear" placeholder="e.g., 2020"></div></div></div></div>
                    </div>
                    
                    <!-- Metabolic -->
                    <div style="background-color:#fef3c7;border-left:4px solid #f59e0b;padding:1rem;margin-bottom:1.5rem;border-radius:4px">
                        <h3 style="margin:0 0 1rem 0;font-size:.875rem;font-weight:700;text-transform:uppercase;color:#92400e">‚ö° Metabolic & Endocrine</h3>
                        <div class="condition-item"><label><strong>Diabetes</strong> <span class="required">*</span></label><div class="radio-group" style="margin-bottom:.5rem"><div class="radio-item"><input type="radio" id="diabetes_yes" name="diabetes" value="Yes" required class="condition-radio"><label for="diabetes_yes">Yes</label></div><div class="radio-item"><input type="radio" id="diabetes_no" name="diabetes" value="No" class="condition-radio"><label for="diabetes_no">No</label></div></div><div class="condition-details" id="diabetes-details"><div class="form-row" style="margin-bottom:0"><div class="form-group"><label for="diabetes-type">Type</label><input type="text" id="diabetes-type" name="diabetesType" placeholder="Type 1, Type 2"></div><div class="form-group"><label for="diabetes-year">Year</label><input type="text" id="diabetes-year" name="diabetesYear" placeholder="e.g., 2020"></div></div></div></div>
                        <div class="condition-item"><label><strong>Thyroid Disorder</strong> <span class="required">*</span></label><div class="radio-group" style="margin-bottom:.5rem"><div class="radio-item"><input type="radio" id="thyroid_yes" name="thyroid" value="Yes" required class="condition-radio"><label for="thyroid_yes">Yes</label></div><div class="radio-item"><input type="radio" id="thyroid_no" name="thyroid" value="No" class="condition-radio"><label for="thyroid_no">No</label></div></div><div class="condition-details" id="thyroid-details"><div class="form-row" style="margin-bottom:0"><div class="form-group"><label for="thyroid-type">Type</label><input type="text" id="thyroid-type" name="thyroidType" placeholder="e.g., Hypothyroid"></div><div class="form-group"><label for="thyroid-year">Year</label><input type="text" id="thyroid-year" name="thyroidYear" placeholder="e.g., 2020"></div></div></div></div>
                    </div>
                    
                    <!-- Mental Health -->
                    <div style="background-color:#ede9fe;border-left:4px solid #8b5cf6;padding:1rem;margin-bottom:1.5rem;border-radius:4px">
                        <h3 style="margin:0 0 1rem 0;font-size:.875rem;font-weight:700;text-transform:uppercase;color:#5b21b6">üß† Mental Health</h3>
                        <div class="condition-item"><label><strong>Depression / Anxiety</strong> <span class="required">*</span></label><div class="radio-group" style="margin-bottom:.5rem"><div class="radio-item"><input type="radio" id="depression_yes" name="depression" value="Yes" required class="condition-radio"><label for="depression_yes">Yes</label></div><div class="radio-item"><input type="radio" id="depression_no" name="depression" value="No" class="condition-radio"><label for="depression_no">No</label></div></div><div class="condition-details" id="depression-details"><div class="form-group"><label for="depression-year">Year Diagnosed</label><input type="text" id="depression-year" name="depressionYear" placeholder="e.g., 2020"></div></div></div>
                        <div class="condition-item"><label><strong>Eating Disorder</strong> <span class="required">*</span></label><div class="radio-group" style="margin-bottom:.5rem"><div class="radio-item"><input type="radio" id="eatingDisorder_yes" name="eatingDisorder" value="Yes" required class="condition-radio"><label for="eatingDisorder_yes">Yes</label></div><div class="radio-item"><input type="radio" id="eatingDisorder_no" name="eatingDisorder" value="No" class="condition-radio"><label for="eatingDisorder_no">No</label></div></div><div class="condition-details" id="eatingDisorder-details"><div class="form-row" style="margin-bottom:0"><div class="form-group"><label for="eatingDisorder-type">Type</label><input type="text" id="eatingDisorder-type" name="eatingDisorderType" placeholder="e.g., Anorexia, Bulimia, BED"></div><div class="form-group"><label for="eatingDisorder-year">Year</label><input type="text" id="eatingDisorder-year" name="eatingDisorderYear" placeholder="e.g., 2020"></div></div></div></div>
                    </div>
                    
                    <!-- Organ Health -->
                    <div style="background-color:#dbeafe;border-left:4px solid #3b82f6;padding:1rem;margin-bottom:1.5rem;border-radius:4px">
                        <h3 style="margin:0 0 1rem 0;font-size:.875rem;font-weight:700;text-transform:uppercase;color:#1e40af">ü´Å Organ Health</h3>
                        <div class="condition-item"><label><strong>Kidney Disease</strong> <span class="required">*</span></label><div class="radio-group" style="margin-bottom:.5rem"><div class="radio-item"><input type="radio" id="kidney_yes" name="kidney" value="Yes" required class="condition-radio"><label for="kidney_yes">Yes</label></div><div class="radio-item"><input type="radio" id="kidney_no" name="kidney" value="No" class="condition-radio"><label for="kidney_no">No</label></div></div><div class="condition-details" id="kidney-details"><div class="form-row" style="margin-bottom:0"><div class="form-group"><label for="kidney-type">Type</label><input type="text" id="kidney-type" name="kidneyType" placeholder="e.g., CKD"></div><div class="form-group"><label for="kidney-year">Year</label><input type="text" id="kidney-year" name="kidneyYear" placeholder="e.g., 2020"></div></div></div></div>
                        <div class="condition-item"><label><strong>Liver Disease</strong> <span class="required">*</span></label><div class="radio-group" style="margin-bottom:.5rem"><div class="radio-item"><input type="radio" id="liver_yes" name="liver" value="Yes" required class="condition-radio"><label for="liver_yes">Yes</label></div><div class="radio-item"><input type="radio" id="liver_no" name="liver" value="No" class="condition-radio"><label for="liver_no">No</label></div></div><div class="condition-details" id="liver-details"><div class="form-row" style="margin-bottom:0"><div class="form-group"><label for="liver-type">Type</label><input type="text" id="liver-type" name="liverType" placeholder="e.g., Fatty Liver"></div><div class="form-group"><label for="liver-year">Year</label><input type="text" id="liver-year" name="liverYear" placeholder="e.g., 2020"></div></div></div></div>
                    </div>
                    
                    <!-- Immune & Cancer -->
                    <div style="background-color:#f3e8ff;border-left:4px solid #a855f7;padding:1rem;margin-bottom:1.5rem;border-radius:4px">
                        <h3 style="margin:0 0 1rem 0;font-size:.875rem;font-weight:700;text-transform:uppercase;color:#6b21a8">üõ°Ô∏è Immune & Cancer</h3>
                        <div class="condition-item"><label><strong>Autoimmune Disorder</strong> <span class="required">*</span></label><div class="radio-group" style="margin-bottom:.5rem"><div class="radio-item"><input type="radio" id="autoimmune_yes" name="autoimmune" value="Yes" required class="condition-radio"><label for="autoimmune_yes">Yes</label></div><div class="radio-item"><input type="radio" id="autoimmune_no" name="autoimmune" value="No" class="condition-radio"><label for="autoimmune_no">No</label></div></div><div class="condition-details" id="autoimmune-details"><div class="form-row" style="margin-bottom:0"><div class="form-group"><label for="autoimmune-type">Type</label><input type="text" id="autoimmune-type" name="autoimmuneType" placeholder="e.g., Lupus, RA"></div><div class="form-group"><label for="autoimmune-year">Year</label><input type="text" id="autoimmune-year" name="autoimmuneYear" placeholder="e.g., 2020"></div></div></div></div>
                        <div class="condition-item"><label><strong>Cancer</strong> <span class="required">*</span></label><div class="radio-group" style="margin-bottom:.5rem"><div class="radio-item"><input type="radio" id="cancer_yes" name="cancer" value="Yes" required class="condition-radio"><label for="cancer_yes">Yes</label></div><div class="radio-item"><input type="radio" id="cancer_no" name="cancer" value="No" class="condition-radio"><label for="cancer_no">No</label></div></div><div class="condition-details" id="cancer-details"><div class="form-row" style="margin-bottom:0"><div class="form-group"><label for="cancer-type">Type</label><input type="text" id="cancer-type" name="cancerType" placeholder="e.g., Breast, Prostate"></div><div class="form-group"><label for="cancer-year">Year</label><input type="text" id="cancer-year" name="cancerYear" placeholder="e.g., 2020"></div></div></div></div>
                    </div>
                    
                    <div style="background-color:#f0fdf4;border:2px solid #22c55e;padding:1rem;border-radius:4px"><p style="margin:0;color:#15803d;font-size:.9375rem">‚úÖ <strong>No conditions?</strong> If you answered NO to all, you're all set!</p></div>
                </div>
                
                <!-- Medications & Allergies -->
                <div class="section">
                    <h2 class="section-title">Medications & Allergies</h2>
                    <div class="form-row"><div class="form-group full-width" style="background-color:#dbeafe;border:2px solid #3b82f6;padding:1.5rem;border-radius:4px;margin-bottom:2rem"><label style="font-size:1.125rem;font-weight:600;color:#1e40af;margin-bottom:1rem;display:block">Are you currently on Hormone Replacement Therapy (HRT)? <span class="required">*</span></label><div class="radio-group"><div class="radio-item"><input type="radio" id="hrtYes" name="onHRT" value="Yes" required><label for="hrtYes">Yes</label></div><div class="radio-item"><input type="radio" id="hrtNo" name="onHRT" value="No"><label for="hrtNo">No</label></div></div><span class="field-error" id="onHRTError">Please select an option</span><div class="conditional-field" id="hrtFields" style="margin-top:1rem"><div class="form-group"><label for="hrtDetails">HRT Details <span class="required">*</span></label><textarea id="hrtDetails" name="hrtDetails" rows="2" placeholder="Type, dosage, frequency (e.g., Testosterone Cypionate 200mg weekly)"></textarea></div></div></div></div>
                    <div class="form-row"><div class="form-group full-width"><label>Are you on any other Medications? <span class="required">*</span></label><div class="radio-group"><div class="radio-item"><input type="radio" id="medicationsYes" name="onMedications" value="Yes" required><label for="medicationsYes">Yes</label></div><div class="radio-item"><input type="radio" id="medicationsNo" name="onMedications" value="No"><label for="medicationsNo">No</label></div></div><span class="field-error" id="onMedicationsError">Please select an option</span><div class="conditional-field" id="medicationsFields"><div class="form-group" style="margin-bottom:1rem"><label for="currentMedications">Current Medications <span class="required">*</span></label><textarea id="currentMedications" name="currentMedications" rows="3" placeholder="List all current medications"></textarea></div><div class="form-group"><label for="medicationNotes">Medication Notes</label><textarea id="medicationNotes" name="medicationNotes" rows="2" placeholder="Any additional notes..."></textarea></div></div></div></div>
                    <div class="form-row"><div class="form-group full-width"><label>Do you have any allergies? <span class="required">*</span></label><div class="radio-group"><div class="radio-item"><input type="radio" id="allergiesYes" name="hasAllergies" value="Yes" required><label for="allergiesYes">Yes</label></div><div class="radio-item"><input type="radio" id="allergiesNo" name="hasAllergies" value="No"><label for="allergiesNo">No</label></div></div><span class="field-error" id="hasAllergiesError">Please select an option</span><div class="conditional-field" id="allergiesFields"><div class="form-group" style="margin-bottom:1rem"><label for="allergies">Allergies <span class="required">*</span></label><textarea id="allergies" name="allergies" rows="3" placeholder="List all allergies"></textarea></div><div class="form-group"><label for="allergyReactions">Reactions</label><textarea id="allergyReactions" name="allergyReactions" rows="2" placeholder="Describe reactions..."></textarea></div></div></div></div>
                </div>
                
                <!-- Identification -->
                <div class="section">
                    <h2 class="section-title">Identification</h2>
                    <div class="form-row"><div class="form-group full-width"><label>Driver's License / Photo ID <span class="required">*</span></label><div class="file-upload"><input type="file" id="photoId" name="photoId" class="file-upload-input" accept="image/*,.pdf" required><div class="file-upload-label"><span class="file-upload-icon">üìÑ</span><span class="file-upload-text">Click or drag to upload your ID</span><span class="file-upload-text" style="font-size:.75rem;margin-top:.25rem">Accepted: JPG, PNG, PDF</span></div></div><div class="file-preview" id="idPreview"><img id="idPreviewImg" alt="ID Preview"><p id="idFileName" style="font-size:.875rem;color:var(--gray-600);margin-top:.5rem"></p></div><span class="field-error" id="photoIdError">Photo ID is required</span></div></div>
                    <div class="form-row"><div class="form-group full-width"><label for="guardianName">Parent/Guardian Name (if under 18)</label><input type="text" id="guardianName" name="guardianName" placeholder="Leave blank if not applicable"></div></div>
                </div>
                
                <!-- Consent -->
                <div class="section">
                    <h2 class="section-title">Consent & Acknowledgment</h2>
                    <div class="consent-box"><p class="consent-text">I consent to evaluation and wellness services provided by Range Medical staff under the supervision of the medical director. I understand some therapies may be used off-label and that individual results can vary. I authorize Range Medical to contact me via the methods provided above. I acknowledge responsibility for payment for services rendered and have reviewed any posted cancellation/no-show policies.</p><div class="radio-group"><div class="radio-item"><input type="radio" id="consentYes" name="consent" value="Yes" required><label for="consentYes">Yes, I agree</label></div><div class="radio-item"><input type="radio" id="consentNo" name="consent" value="No"><label for="consentNo">No, I do not agree</label></div></div><span class="field-error" id="consentError">Consent is required to proceed</span></div>
                    <div class="form-row"><div class="form-group full-width"><label>Patient or Guardian Signature <span class="required">*</span></label><div class="signature-container"><canvas id="signaturePad" class="signature-pad"></canvas></div><div class="signature-actions"><button type="button" class="btn-clear" id="clearSignature">Clear Signature</button></div><span class="field-error" id="signatureError">Signature is required</span></div></div>
                </div>
                
                <div class="submit-section"><button type="submit" class="btn-submit" id="submitBtn">Submit Intake Form</button><div class="status-message" id="statusMessage"></div></div>
            </form>
        </div>
        <footer class="footer"><p>&copy; 2025 Range Medical. All rights reserved.</p><p style="margin-top:.5rem">Your information is protected and kept confidential.</p></footer>
    </div>

<script>
// ============================================
// CONFIGURATION
// ============================================
const CONFIG = {
    emailjs: {
        publicKey: 'ZeNFfwJ37Uhd6E1vp',
        serviceId: 'service_pyl6wra',
        templateId: 'template_3pfsl9b'
    },
    supabase: {
        url: 'https://teivfptpozltpqwahgdl.supabase.co',
        anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRlaXZmcHRwb3psdHBxd2FoZ2RsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MTMxNDksImV4cCI6MjA4MDI4OTE0OX0.NrI1AykMBOh91mM9BFvpSH0JwzGrkv5ADDkZinh0elc'
    },
    api: {
        intakes: 'https://rangemedical-system-2.vercel.app/api/intakes',
        ghl: 'https://rangemedical-system-2.vercel.app/api/intake-to-ghl'
    },
    recipientEmail: 'cupp@range-medical.com'
};

// ============================================
// SUPABASE CLIENT
// ============================================
const supabaseClient = supabase.createClient(CONFIG.supabase.url, CONFIG.supabase.anonKey);

// ============================================
// SIGNATURE PAD
// ============================================
const canvas = document.getElementById('signaturePad');
const signaturePad = new SignaturePad(canvas, {
    backgroundColor: 'rgb(255, 255, 255)',
    penColor: 'rgb(0, 0, 0)'
});

function resizeCanvas() {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    const container = canvas.parentElement;
    canvas.width = container.offsetWidth * ratio;
    canvas.height = 150 * ratio;
    canvas.getContext('2d').scale(ratio, ratio);
    canvas.style.width = '100%';
    canvas.style.height = '150px';
    signaturePad.clear();
}

window.addEventListener('resize', resizeCanvas);
resizeCanvas();

document.getElementById('clearSignature').addEventListener('click', function() {
    signaturePad.clear();
});

// ============================================
// CONDITIONAL FIELDS
// ============================================
document.querySelectorAll('.condition-radio').forEach(radio => {
    radio.addEventListener('change', function() {
        const detailsEl = document.getElementById(this.name + '-details');
        if (detailsEl) {
            if (this.value === 'Yes') {
                detailsEl.style.display = 'block';
            } else {
                detailsEl.style.display = 'none';
                detailsEl.querySelectorAll('input, textarea').forEach(i => i.value = '');
            }
        }
    });
});

document.querySelectorAll('input[name="injured"]').forEach(r => {
    r.addEventListener('change', function() {
        const f = document.getElementById('injuryFields');
        if (this.value === 'Yes') {
            f.classList.add('visible');
        } else {
            f.classList.remove('visible');
            document.getElementById('injuryDescription').value = '';
            document.getElementById('injuryLocation').value = '';
            document.getElementById('injuryDate').value = '';
        }
    });
});

document.querySelectorAll('input[name="onHRT"]').forEach(r => {
    r.addEventListener('change', function() {
        const f = document.getElementById('hrtFields');
        if (this.value === 'Yes') {
            f.classList.add('visible');
        } else {
            f.classList.remove('visible');
            document.getElementById('hrtDetails').value = '';
        }
    });
});

document.querySelectorAll('input[name="onMedications"]').forEach(r => {
    r.addEventListener('change', function() {
        document.getElementById('medicationsFields').classList.toggle('visible', this.value === 'Yes');
    });
});

document.querySelectorAll('input[name="hasAllergies"]').forEach(r => {
    r.addEventListener('change', function() {
        document.getElementById('allergiesFields').classList.toggle('visible', this.value === 'Yes');
    });
});

// ============================================
// FILE UPLOAD PREVIEW
// ============================================
document.getElementById('photoId').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('idPreview');
    const previewImg = document.getElementById('idPreviewImg');
    const fileName = document.getElementById('idFileName');
    
    if (file) {
        preview.classList.add('visible');
        fileName.textContent = file.name;
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                previewImg.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            previewImg.style.display = 'none';
        }
    } else {
        preview.classList.remove('visible');
    }
});

// ============================================
// PHONE FORMATTING
// ============================================
document.getElementById('phone').addEventListener('input', function(e) {
    let v = e.target.value.replace(/\D/g, '');
    if (v.length > 0) {
        if (v.length <= 3) {
            v = '(' + v;
        } else if (v.length <= 6) {
            v = '(' + v.slice(0, 3) + ') ' + v.slice(3);
        } else {
            v = '(' + v.slice(0, 3) + ') ' + v.slice(3, 6) + '-' + v.slice(6, 10);
        }
    }
    e.target.value = v;
});

// ============================================
// FORM VALIDATION
// ============================================
function validateForm() {
    let isValid = true;
    
    const requiredFields = [
        { id: 'firstName', error: 'firstNameError' },
        { id: 'lastName', error: 'lastNameError' },
        { id: 'gender', error: 'genderError' },
        { id: 'dob', error: 'dobError' },
        { id: 'email', error: 'emailError' },
        { id: 'phone', error: 'phoneError' },
        { id: 'streetAddress', error: 'streetAddressError' },
        { id: 'city', error: 'cityError' },
        { id: 'state', error: 'stateError' },
        { id: 'country', error: 'countryError' },
        { id: 'postalCode', error: 'postalCodeError' },
        { id: 'whatBringsYou', error: 'whatBringsYouError' }
    ];
    
    requiredFields.forEach(f => {
        const input = document.getElementById(f.id);
        const error = document.getElementById(f.error);
        if (!input.value.trim()) {
            input.classList.add('error');
            error.classList.add('visible');
            isValid = false;
        } else {
            input.classList.remove('error');
            error.classList.remove('visible');
        }
    });
    
    const email = document.getElementById('email');
    if (email.value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.value)) {
        email.classList.add('error');
        document.getElementById('emailError').classList.add('visible');
        isValid = false;
    }
    
    const radioGroups = [
        { name: 'injured', error: 'injuredError' },
        { name: 'onMedications', error: 'onMedicationsError' },
        { name: 'hasAllergies', error: 'hasAllergiesError' },
        { name: 'consent', error: 'consentError' }
    ];
    
    radioGroups.forEach(g => {
        const checked = document.querySelector(`input[name="${g.name}"]:checked`);
        const error = document.getElementById(g.error);
        if (!checked) {
            error.classList.add('visible');
            isValid = false;
        } else {
            error.classList.remove('visible');
        }
    });
    
    const consent = document.querySelector('input[name="consent"]:checked');
    if (consent && consent.value === 'No') {
        document.getElementById('consentError').classList.add('visible');
        document.getElementById('consentError').textContent = 'You must consent to proceed';
        isValid = false;
    }
    
    const injured = document.querySelector('input[name="injured"]:checked');
    if (injured && injured.value === 'Yes') {
        if (!document.getElementById('injuryDescription').value.trim()) {
            document.getElementById('injuryDescription').classList.add('error');
            document.getElementById('injuryDescriptionError').classList.add('visible');
            isValid = false;
        }
        if (!document.getElementById('injuryLocation').value.trim()) {
            document.getElementById('injuryLocation').classList.add('error');
            document.getElementById('injuryLocationError').classList.add('visible');
            isValid = false;
        }
    }
    
    const photoId = document.getElementById('photoId');
    if (!photoId.files || !photoId.files[0]) {
        document.getElementById('photoIdError').classList.add('visible');
        isValid = false;
    } else {
        document.getElementById('photoIdError').classList.remove('visible');
    }
    
    if (signaturePad.isEmpty()) {
        document.getElementById('signatureError').classList.add('visible');
        isValid = false;
    } else {
        document.getElementById('signatureError').classList.remove('visible');
    }
    
    return isValid;
}

// ============================================
// UPLOAD FILE TO SUPABASE STORAGE
// ============================================
async function uploadFileToStorage(file, folder, patientName) {
    try {
        const timestamp = Date.now();
        const safeName = patientName.replace(/[^a-z0-9]/gi, '-').toLowerCase();
        const extension = file.name.split('.').pop() || 'jpg';
        const fileName = `${safeName}-${timestamp}.${extension}`;
        const filePath = `${folder}/${fileName}`;
        
        console.log(`üì§ Uploading to ${folder}:`, filePath);
        
        const { data, error } = await supabaseClient.storage
            .from('medical-documents')
            .upload(filePath, file, {
                contentType: file.type,
                cacheControl: '3600',
                upsert: false
            });
        
        if (error) throw error;
        
        const { data: { publicUrl } } = supabaseClient.storage
            .from('medical-documents')
            .getPublicUrl(filePath);
        
        console.log(`‚úÖ ${folder} uploaded:`, publicUrl);
        return publicUrl;
    } catch (error) {
        console.error(`Error uploading ${folder}:`, error);
        return null;
    }
}

async function uploadBase64ToStorage(base64Data, folder, patientName, extension = 'png') {
    try {
        const timestamp = Date.now();
        const safeName = patientName.replace(/[^a-z0-9]/gi, '-').toLowerCase();
        const fileName = `${safeName}-${timestamp}.${extension}`;
        const filePath = `${folder}/${fileName}`;
        
        // Convert base64 to blob
        const base64Content = base64Data.split(',')[1];
        const mimeType = base64Data.split(';')[0].split(':')[1] || 'image/png';
        const byteCharacters = atob(base64Content);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: mimeType });
        
        console.log(`üì§ Uploading to ${folder}:`, filePath);
        
        const { data, error } = await supabaseClient.storage
            .from('medical-documents')
            .upload(filePath, blob, {
                contentType: mimeType,
                cacheControl: '3600',
                upsert: false
            });
        
        if (error) throw error;
        
        const { data: { publicUrl } } = supabaseClient.storage
            .from('medical-documents')
            .getPublicUrl(filePath);
        
        console.log(`‚úÖ ${folder} uploaded:`, publicUrl);
        return publicUrl;
    } catch (error) {
        console.error(`Error uploading ${folder}:`, error);
        return null;
    }
}

// ============================================
// COLLECT FORM DATA
// ============================================
async function collectFormData() {
    const getValue = (id) => document.getElementById(id)?.value || '';
    const getRadio = (name) => document.querySelector(`input[name="${name}"]:checked`)?.value || '';
    
    const conditionNames = ['hypertension', 'highCholesterol', 'heartDisease', 'diabetes', 'thyroid', 'depression', 'eatingDisorder', 'kidney', 'liver', 'autoimmune', 'cancer'];
    const conditionLabels = {
        'hypertension': 'High Blood Pressure',
        'highCholesterol': 'High Cholesterol',
        'heartDisease': 'Heart Disease',
        'diabetes': 'Diabetes',
        'thyroid': 'Thyroid Disorder',
        'depression': 'Depression/Anxiety',
        'eatingDisorder': 'Eating Disorder',
        'kidney': 'Kidney Disease',
        'liver': 'Liver Disease',
        'autoimmune': 'Autoimmune Disorder',
        'cancer': 'Cancer'
    };
    
    const medicalHistory = {};
    conditionNames.forEach(conditionName => {
        const response = getRadio(conditionName);
        medicalHistory[conditionName] = { response: response, label: conditionLabels[conditionName] };
        
        if (response === 'Yes') {
            const yearEl = document.getElementById(conditionName + '-year');
            const typeEl = document.getElementById(conditionName + '-type');
            if (typeEl && typeEl.value) medicalHistory[conditionName].type = typeEl.value;
            if (yearEl && yearEl.value) medicalHistory[conditionName].year = yearEl.value;
        }
    });
    
    return {
        firstName: getValue('firstName'),
        lastName: getValue('lastName'),
        preferredName: getValue('preferredName'),
        gender: getValue('gender'),
        dateOfBirth: getValue('dob'),
        email: getValue('email'),
        phone: getValue('phone'),
        streetAddress: getValue('streetAddress'),
        city: getValue('city'),
        state: getValue('state'),
        country: getValue('country'),
        postalCode: getValue('postalCode'),
        whatBringsYou: getValue('whatBringsYou'),
        injured: getRadio('injured'),
        injuryDescription: getValue('injuryDescription'),
        injuryLocation: getValue('injuryLocation'),
        injuryDate: getValue('injuryDate'),
        medicalHistory: medicalHistory,
        onHRT: getRadio('onHRT'),
        hrtDetails: getValue('hrtDetails'),
        onMedications: getRadio('onMedications'),
        currentMedications: getValue('currentMedications'),
        medicationNotes: getValue('medicationNotes'),
        hasAllergies: getRadio('hasAllergies'),
        allergies: getValue('allergies'),
        allergyReactions: getValue('allergyReactions'),
        guardianName: getValue('guardianName'),
        consent: getRadio('consent'),
        submissionDate: new Date().toLocaleString(),
        signature: signaturePad.toDataURL()
    };
}

// ============================================
// GENERATE PDF
// ============================================
async function generatePDF(formData) {
    let jsPDF;
    if (window.jspdf && window.jspdf.jsPDF) {
        jsPDF = window.jspdf.jsPDF;
    } else if (window.jsPDF) {
        jsPDF = window.jsPDF;
    } else {
        throw new Error('jsPDF not loaded');
    }
    
    const doc = new jsPDF({ compress: true });
    let yPos = 20;
    const leftMargin = 20;
    const pageWidth = doc.internal.pageSize.getWidth();
    const contentWidth = pageWidth - 40;
    
    function addText(text, fontSize = 11, isBold = false) {
        doc.setFontSize(fontSize);
        doc.setFont('helvetica', isBold ? 'bold' : 'normal');
        const lines = doc.splitTextToSize(String(text || ''), contentWidth);
        doc.text(lines, leftMargin, yPos);
        yPos += (lines.length * fontSize * 0.4) + 2;
        if (yPos > 270) { doc.addPage(); yPos = 20; }
    }
    
    function addLabelValue(label, value) {
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.text(label, leftMargin, yPos);
        doc.setFont('helvetica', 'normal');
        const labelWidth = doc.getTextWidth(label) + 2;
        const valueLines = doc.splitTextToSize(String(value || 'N/A'), contentWidth - labelWidth - 10);
        doc.text(valueLines, leftMargin + labelWidth, yPos);
        yPos += (valueLines.length * 5) + 3;
        if (yPos > 270) { doc.addPage(); yPos = 20; }
    }
    
    function addSection(text) {
        yPos += 5;
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text(text, leftMargin, yPos);
        yPos += 2;
        doc.setLineWidth(0.5);
        doc.line(leftMargin, yPos, pageWidth - leftMargin, yPos);
        yPos += 8;
    }
    
    // Header
    doc.setFontSize(22);
    doc.setFont('helvetica', 'bold');
    doc.text('RANGE MEDICAL', pageWidth / 2, yPos, { align: 'center' });
    yPos += 8;
    doc.setFontSize(14);
    doc.setFont('helvetica', 'normal');
    doc.text('New Patient Medical Intake Form', pageWidth / 2, yPos, { align: 'center' });
    yPos += 6;
    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.text('Submitted: ' + formData.submissionDate, pageWidth / 2, yPos, { align: 'center' });
    doc.setTextColor(0);
    yPos += 5;
    doc.setLineWidth(1);
    doc.line(leftMargin, yPos, pageWidth - leftMargin, yPos);
    yPos += 10;
    
    // Personal Info
    addSection('PERSONAL INFORMATION');
    addLabelValue('Legal Name: ', formData.firstName + ' ' + formData.lastName);
    if (formData.preferredName) addLabelValue('Preferred Name: ', formData.preferredName);
    addLabelValue('Gender: ', formData.gender);
    addLabelValue('DOB: ', formData.dateOfBirth);
    addLabelValue('Email: ', formData.email);
    addLabelValue('Phone: ', formData.phone);
    
    // Address
    addSection('ADDRESS');
    addText(formData.streetAddress);
    addText(formData.city + ', ' + formData.state + ' ' + formData.postalCode);
    addText(formData.country);
    
    // Health Concerns
    addSection('HEALTH CONCERNS');
    addLabelValue('What Brings You In: ', formData.whatBringsYou);
    addLabelValue('Injured: ', formData.injured);
    if (formData.injured === 'Yes') {
        addLabelValue('Injury: ', formData.injuryDescription);
        addLabelValue('Location: ', formData.injuryLocation);
        if (formData.injuryDate) addLabelValue('When: ', formData.injuryDate);
    }
    
    // Medical History
    addSection('MEDICAL HISTORY');
    if (formData.medicalHistory) {
        Object.keys(formData.medicalHistory).forEach(key => {
            const c = formData.medicalHistory[key];
            let text = `${c.label}: ${c.response}`;
            if (c.response === 'Yes') {
                if (c.type) text += ` (${c.type})`;
                if (c.year) text += ` [${c.year}]`;
            }
            addText(text, 10);
        });
    }
    
    // Medications
    addSection('MEDICATIONS & ALLERGIES');
    addLabelValue('On HRT: ', formData.onHRT);
    if (formData.onHRT === 'Yes') addLabelValue('HRT Details: ', formData.hrtDetails);
    addLabelValue('On Medications: ', formData.onMedications);
    if (formData.onMedications === 'Yes') addLabelValue('Medications: ', formData.currentMedications);
    addLabelValue('Has Allergies: ', formData.hasAllergies);
    if (formData.hasAllergies === 'Yes') addLabelValue('Allergies: ', formData.allergies);
    
    // Consent
    addSection('CONSENT');
    addLabelValue('Consent Given: ', formData.consent);
    addText('Signature: Provided electronically', 10);
    addText('Photo ID: Uploaded separately', 10);
    
    // Footer
    yPos += 10;
    doc.setLineWidth(1);
    doc.line(leftMargin, yPos, pageWidth - leftMargin, yPos);
    yPos += 8;
    doc.setFontSize(9);
    doc.setTextColor(100);
    doc.text('¬© 2025 Range Medical | Confidential Patient Information', pageWidth / 2, yPos, { align: 'center' });
    
    return doc.output('blob');
}

// ============================================
// UPLOAD PDF TO STORAGE
// ============================================
async function uploadPDFToStorage(pdfBlob, formData) {
    try {
        const timestamp = Date.now();
        const fileName = `intake-${formData.firstName}-${formData.lastName}-${timestamp}.pdf`;
        const filePath = `medical-intake/${fileName}`;
        
        console.log('üì§ Uploading PDF:', filePath);
        
        const { data, error } = await supabaseClient.storage
            .from('medical-documents')
            .upload(filePath, pdfBlob, {
                contentType: 'application/pdf',
                cacheControl: '3600',
                upsert: false
            });
        
        if (error) throw error;
        
        const { data: { publicUrl } } = supabaseClient.storage
            .from('medical-documents')
            .getPublicUrl(filePath);
        
        console.log('‚úÖ PDF uploaded:', publicUrl);
        return publicUrl;
    } catch (error) {
        console.error('Error uploading PDF:', error);
        throw error;
    }
}

// ============================================
// SAVE TO DATABASE (URLs only)
// ============================================
async function saveToDatabase(formData, urls) {
    try {
        console.log('üíæ Saving to database...');
        
        const response = await fetch(CONFIG.api.intakes, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                firstName: formData.firstName,
                lastName: formData.lastName,
                preferredName: formData.preferredName,
                email: formData.email,
                phone: formData.phone,
                dateOfBirth: formData.dateOfBirth,
                gender: formData.gender,
                streetAddress: formData.streetAddress,
                city: formData.city,
                state: formData.state,
                country: formData.country,
                postalCode: formData.postalCode,
                whatBringsYou: formData.whatBringsYou,
                injured: formData.injured,
                injuryDescription: formData.injuryDescription,
                injuryLocation: formData.injuryLocation,
                injuryDate: formData.injuryDate,
                medicalHistory: formData.medicalHistory,
                onHRT: formData.onHRT,
                hrtDetails: formData.hrtDetails,
                onMedications: formData.onMedications,
                currentMedications: formData.currentMedications,
                medicationNotes: formData.medicationNotes,
                hasAllergies: formData.hasAllergies,
                allergies: formData.allergies,
                allergyReactions: formData.allergyReactions,
                guardianName: formData.guardianName,
                consent: formData.consent,
                // URLs only - no base64
                photoIdUrl: urls.photoIdUrl,
                signatureUrl: urls.signatureUrl,
                pdfUrl: urls.pdfUrl
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            console.log('‚úÖ Saved! Patient:', result.patientId, 'Intake:', result.intakeId);
        } else {
            console.error('‚ùå DB save failed:', result.error);
        }
        
        return result;
    } catch (error) {
        console.error('‚ùå Error saving to DB:', error);
        return { success: false, error: error.message };
    }
}

// ============================================
// SEND TO GOHIGHLEVEL (with document URLs)
// ============================================
async function sendToGoHighLevel(formData, urls) {
    try {
        console.log('üì§ Sending to GoHighLevel...');
        
        const response = await fetch(CONFIG.api.ghl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                firstName: formData.firstName,
                lastName: formData.lastName,
                preferredName: formData.preferredName,
                email: formData.email,
                phone: formData.phone,
                dateOfBirth: formData.dateOfBirth,
                streetAddress: formData.streetAddress,
                city: formData.city,
                state: formData.state,
                postalCode: formData.postalCode,
                country: formData.country || 'US',
                // All document URLs for the note
                pdfUrl: urls.pdfUrl,
                photoIdUrl: urls.photoIdUrl,
                signatureUrl: urls.signatureUrl
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            console.log('‚úÖ GHL sync successful! Contact:', result.contactId);
        } else {
            console.error('‚ùå GHL sync failed:', result.error);
        }
        
        return result;
    } catch (error) {
        console.error('Error sending to GHL:', error);
        return { success: false, error: error.message };
    }
}

// ============================================
// SEND EMAIL
// ============================================
async function sendEmail(formData, pdfBlob) {
    emailjs.init(CONFIG.emailjs.publicKey);
    
    const base64PDF = await new Promise((resolve) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result.split(',')[1]);
        reader.readAsDataURL(pdfBlob);
    });
    
    let messageBody = `NEW PATIENT INTAKE: ${formData.firstName} ${formData.lastName}\n`;
    messageBody += `Email: ${formData.email}\nPhone: ${formData.phone}\n`;
    messageBody += `DOB: ${formData.dateOfBirth}\nGender: ${formData.gender}\n\n`;
    messageBody += `Address: ${formData.streetAddress}, ${formData.city}, ${formData.state} ${formData.postalCode}\n\n`;
    messageBody += `What Brings You In: ${formData.whatBringsYou}\n`;
    messageBody += `Injured: ${formData.injured}\n`;
    messageBody += `On HRT: ${formData.onHRT}\n`;
    messageBody += `Has Allergies: ${formData.hasAllergies}\n\n`;
    messageBody += `Consent Given: ${formData.consent}\n`;
    messageBody += `Submitted: ${formData.submissionDate}\n\n`;
    messageBody += `See attached PDF for complete details.`;
    
    const templateParams = {
        to_email: CONFIG.recipientEmail,
        from_name: `${formData.firstName} ${formData.lastName}`,
        patient_name: `${formData.firstName} ${formData.lastName}`,
        patient_email: formData.email,
        patient_phone: formData.phone,
        submission_date: formData.submissionDate,
        message: messageBody,
        content: base64PDF,
        filename: `RangeMedical_Intake_${formData.lastName}_${formData.firstName}.pdf`
    };
    
    console.log('üìß Sending email...');
    const response = await emailjs.send(CONFIG.emailjs.serviceId, CONFIG.emailjs.templateId, templateParams);
    console.log('‚úÖ Email sent');
    return response;
}

// ============================================
// FORM SUBMISSION
// ============================================
document.getElementById('intakeForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!validateForm()) {
        showStatus('Please fill in all required fields correctly.', 'error');
        const firstError = document.querySelector('.field-error.visible');
        if (firstError) firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
    }
    
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Processing...';
    
    try {
        // 1. Collect form data
        showStatus('Collecting form data...', 'loading');
        const formData = await collectFormData();
        const patientName = `${formData.firstName}-${formData.lastName}`;
        console.log('Form data collected');
        
        // 2. Upload Photo ID to Supabase FIRST
        showStatus('Uploading Photo ID...', 'loading');
        let photoIdUrl = null;
        const photoIdInput = document.getElementById('photoId');
        if (photoIdInput.files && photoIdInput.files[0]) {
            photoIdUrl = await uploadFileToStorage(photoIdInput.files[0], 'photo-ids', patientName);
        }
        
        // 3. Upload Signature to Supabase
        showStatus('Uploading Signature...', 'loading');
        let signatureUrl = null;
        if (formData.signature && formData.signature.startsWith('data:')) {
            signatureUrl = await uploadBase64ToStorage(formData.signature, 'signatures', patientName, 'png');
        }
        
        // 4. Generate PDF
        showStatus('Generating PDF...', 'loading');
        const pdfBlob = await generatePDF(formData);
        console.log('PDF generated');
        
        // 5. Upload PDF
        showStatus('Uploading PDF...', 'loading');
        const pdfUrl = await uploadPDFToStorage(pdfBlob, formData);
        
        // Bundle all URLs
        const urls = { photoIdUrl, signatureUrl, pdfUrl };
        console.log('All files uploaded:', urls);
        
        // 6. Send email
        showStatus('Sending to Range Medical...', 'loading');
        await sendEmail(formData, pdfBlob);
        
        // 7. Save to database (URLs only - no large base64)
        showStatus('Creating patient record...', 'loading');
        const dbResult = await saveToDatabase(formData, urls);
        if (!dbResult.success) {
            console.warn('‚ö†Ô∏è Database save issue (non-critical):', dbResult.error);
        }
        
        // 8. Sync to GoHighLevel (with all document URLs)
        showStatus('Syncing to system...', 'loading');
        const ghlResult = await sendToGoHighLevel(formData, urls);
        if (!ghlResult.success) {
            console.warn('‚ö†Ô∏è GHL sync issue (non-critical):', ghlResult.error);
        }
        
        // 9. Show thank you page
        showThankYouPage(formData);
        
    } catch (error) {
        console.error('Submission error:', error);
        showStatus('Error: ' + (error.message || 'Unknown error'), 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Intake Form';
    }
});

function showThankYouPage(formData) {
    const displayName = formData.preferredName || formData.firstName;
    document.querySelector('.container').innerHTML = `
        <div class="thank-you-page">
            <div class="thank-you-icon">‚úì</div>
            <h1>Thank You, ${displayName}!</h1>
            <p class="thank-you-subtitle">Your intake form has been successfully submitted.</p>
            <div class="thank-you-details">
                <p>We've received your information and our team will review it before your appointment.</p>
                <p>A confirmation has been sent to our office.</p>
            </div>
            <div class="thank-you-footer">
                <p>RANGE MEDICAL</p>
            </div>
        </div>
    `;
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function showStatus(message, type) {
    const statusEl = document.getElementById('statusMessage');
    statusEl.textContent = message;
    statusEl.className = 'status-message visible ' + type;
}
</script>
</body>
</html>
