<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Peptide Pipeline - Range Medical</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíä</text></svg>">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa; 
      padding: 20px;
      color: #111;
    }
    
    .header {
      max-width: 1200px;
      margin: 0 auto 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }
    .header h1 {
      font-size: 24px;
      font-weight: 700;
    }
    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .filter-tabs {
      display: flex;
      gap: 8px;
    }
    
    .search-box {
      position: relative;
    }
    .search-box input {
      padding: 8px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      width: 220px;
      transition: all 0.15s;
    }
    .search-box input:focus {
      outline: none;
      border-color: #111;
      width: 280px;
    }
    .search-box input::placeholder {
      color: #9ca3af;
    }
    
    .main-tabs {
      display: flex;
      gap: 0;
      background: #e5e7eb;
      border-radius: 8px;
      padding: 2px;
    }
    .main-tab {
      padding: 8px 20px;
      border: none;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.15s;
      color: #6b7280;
    }
    .main-tab:hover {
      color: #111;
    }
    .main-tab.active {
      background: white;
      color: #111;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .filter-tab {
      padding: 8px 16px;
      border: 2px solid #e5e7eb;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.15s;
    }
    .filter-tab:hover {
      border-color: #111;
    }
    .filter-tab.active {
      background: #111;
      color: white;
      border-color: #111;
    }
    
    .refresh-btn {
      padding: 8px 16px;
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .refresh-btn:hover {
      border-color: #111;
    }
    
    .stats-bar {
      max-width: 1200px;
      margin: 0 auto 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
    }
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      border-left: 4px solid #e5e7eb;
      cursor: pointer;
      transition: all 0.15s;
    }
    .stat-card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .stat-card.active {
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .stat-card.ending { border-left-color: #ef4444; }
    .stat-card.active-protocol { border-left-color: #f59e0b; }
    .stat-card.started { border-left-color: #22c55e; }
    .stat-card.completed { border-left-color: #9ca3af; }
    .stat-card.needs-followup { border-left-color: #8b5cf6; }
    
    .stat-card .label {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .stat-card .value {
      font-size: 28px;
      font-weight: 700;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .section {
      margin-bottom: 24px;
    }
    .section-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e5e7eb;
    }
    .section-header h2 {
      font-size: 16px;
      font-weight: 600;
    }
    .section-header .count {
      background: #f3f4f6;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .patient-grid {
      display: grid;
      gap: 12px;
    }
    
    .patient-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 16px;
      align-items: center;
      border: 1px solid #e5e7eb;
      transition: all 0.15s;
    }
    .patient-card:hover {
      border-color: #111;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .patient-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }
    .patient-info .field {
      min-width: 0;
    }
    .patient-info .field-label {
      font-size: 11px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 2px;
    }
    .patient-info .field-value {
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .patient-info .field-value.name {
      font-size: 16px;
      font-weight: 600;
    }
    
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .badge.in-clinic {
      background: #dbeafe;
      color: #1d4ed8;
    }
    .badge.take-home {
      background: #f3e8ff;
      color: #7c3aed;
    }
    .badge.ending {
      background: #fee2e2;
      color: #dc2626;
    }
    .badge.needs-followup {
      background: #fef3c7;
      color: #d97706;
    }
    
    .days-remaining {
      font-weight: 700;
    }
    .days-remaining.urgent { color: #dc2626; }
    .days-remaining.warning { color: #f59e0b; }
    .days-remaining.ok { color: #22c55e; }
    
    .patient-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }
    .action-btn {
      padding: 8px 12px;
      border: 1px solid #e5e7eb;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s;
      white-space: nowrap;
    }
    .action-btn:hover {
      border-color: #111;
      background: #f9fafb;
    }
    .action-btn.primary {
      background: #111;
      color: white;
      border-color: #111;
    }
    .action-btn.primary:hover {
      background: #333;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 12px;
    }
    
    .loading {
      text-align: center;
      padding: 60px;
      color: #6b7280;
    }
    
    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal h3 {
      font-size: 18px;
      margin-bottom: 16px;
    }
    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      justify-content: flex-end;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
    }
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      min-height: 100px;
    }
    .form-group textarea:focus {
      outline: none;
      border-color: #111;
    }
    
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #111;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 1001;
      display: none;
    }
    .toast.success { background: #22c55e; }
    .toast.error { background: #ef4444; }
    .toast.active { display: block; }

    @media (max-width: 768px) {
      .patient-card {
        grid-template-columns: 1fr;
      }
      .patient-actions {
        justify-content: flex-start;
        flex-wrap: wrap;
      }
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-actions {
        flex-direction: column;
        width: 100%;
        align-items: stretch;
        gap: 12px;
      }
      .search-box input {
        width: 100%;
      }
      .search-box input:focus {
        width: 100%;
      }
      .main-tabs {
        justify-content: center;
      }
      .filter-tabs {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üíä Peptide Protocols</h1>
    <div class="header-actions">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="üîç Search all protocols..." oninput="handleSearch()">
      </div>
      <div class="main-tabs">
        <button class="main-tab active" data-view="active">Active</button>
        <button class="main-tab" data-view="completed">Completed</button>
      </div>
      <div class="filter-tabs" id="deliveryFilters">
        <button class="filter-tab active" data-filter="all">All</button>
        <button class="filter-tab" data-filter="in_clinic">In Clinic</button>
        <button class="filter-tab" data-filter="take_home">Take Home</button>
      </div>
      <button class="refresh-btn" onclick="loadProtocols()">
        ‚Üª Refresh
      </button>
    </div>
  </div>

  <div class="stats-bar" id="activeStats">
    <div class="stat-card ending" data-status="ending" onclick="filterByStatus('ending')">
      <div class="label">Ending Soon (‚â§3 days)</div>
      <div class="value" id="stat-ending">-</div>
    </div>
    <div class="stat-card active-protocol" data-status="active" onclick="filterByStatus('active')">
      <div class="label">Active (4-14 days)</div>
      <div class="value" id="stat-active">-</div>
    </div>
    <div class="stat-card started" data-status="started" onclick="filterByStatus('started')">
      <div class="label">Just Started (15+ days)</div>
      <div class="value" id="stat-started">-</div>
    </div>
    <div class="stat-card needs-followup" data-status="needs-followup" onclick="filterByStatus('needs-followup')">
      <div class="label">Needs Follow-up</div>
      <div class="value" id="stat-followup">-</div>
    </div>
  </div>

  <div class="stats-bar" id="completedStats" style="display: none;">
    <div class="stat-card completed">
      <div class="label">Total Completed</div>
      <div class="value" id="stat-completed">-</div>
    </div>
  </div>

  <div class="container">
    <div id="loading" class="loading">Loading protocols...</div>
    <div id="content" style="display: none;"></div>
  </div>

  <!-- SMS Modal -->
  <div class="modal-overlay" id="smsModal">
    <div class="modal">
      <h3>üì± Send Follow-up SMS</h3>
      <p id="smsPatientName" style="color: #6b7280; margin-bottom: 16px;"></p>
      <div class="form-group">
        <label>Message</label>
        <textarea id="smsMessage">Hi {{first_name}}! üëã

Just checking in on your peptide protocol. How are you feeling? Any questions or concerns?

Reply to this message or call us at (949) 997-3988.

- Range Medical</textarea>
      </div>
      <div class="modal-actions">
        <button class="action-btn" onclick="closeSmsModal()">Cancel</button>
        <button class="action-btn primary" onclick="sendSms()">Send SMS</button>
      </div>
    </div>
  </div>

  <!-- Renew Modal -->
  <div class="modal-overlay" id="renewModal">
    <div class="modal">
      <h3>üîÑ Renew Protocol</h3>
      <p id="renewPatientName" style="color: #6b7280; margin-bottom: 16px;"></p>
      <div class="form-group">
        <label>New Duration</label>
        <select id="renewDuration" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
          <option value="7">7 Days</option>
          <option value="10">10 Days</option>
          <option value="20">20 Days</option>
          <option value="30" selected>30 Days</option>
        </select>
      </div>
      <div class="form-group">
        <label>Notes (optional)</label>
        <textarea id="renewNotes" style="min-height: 60px;" placeholder="Renewal reason, dosage changes, etc."></textarea>
      </div>
      <div class="modal-actions">
        <button class="action-btn" onclick="closeRenewModal()">Cancel</button>
        <button class="action-btn primary" onclick="renewProtocol()">Renew Protocol</button>
      </div>
    </div>
  </div>

  <!-- Edit Protocol Modal -->
  <div class="modal-overlay" id="editModal">
    <div class="modal" style="max-width: 500px;">
      <h3>‚úèÔ∏è Edit Protocol</h3>
      <p id="editPatientName" style="color: #6b7280; margin-bottom: 16px;"></p>
      <div class="form-group">
        <label>Medication</label>
        <input type="text" id="editMedication" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
      </div>
      <div class="form-group">
        <label>Dose</label>
        <input type="text" id="editDose" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
      </div>
      <div class="form-group">
        <label>Start Date</label>
        <input type="date" id="editStartDate" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
      </div>
      <div class="form-group">
        <label>End Date</label>
        <input type="date" id="editEndDate" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
      </div>
      <div class="form-group">
        <label>Delivery Method</label>
        <select id="editDeliveryMethod" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
          <option value="take_home">Take Home</option>
          <option value="in_clinic">In Clinic</option>
        </select>
      </div>
      <div class="form-group">
        <label>Status</label>
        <select id="editStatus" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
          <option value="active">Active</option>
          <option value="completed">Completed</option>
          <option value="paused">Paused</option>
        </select>
      </div>
      <div class="form-group">
        <label>Notes</label>
        <textarea id="editNotes" style="min-height: 60px;" placeholder="Protocol notes..."></textarea>
      </div>
      <div class="modal-actions">
        <button class="action-btn" onclick="closeEditModal()">Cancel</button>
        <button class="action-btn primary" onclick="saveProtocolEdit()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    const API_BASE = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000/api' 
      : 'https://app.range-medical.com/api';
    
    let allProtocols = [];
    let currentFilter = 'all';
    let currentStatusFilter = null;
    let selectedProtocol = null;
    let searchTerm = '';
    let mainView = 'active'; // 'active' or 'completed'

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadProtocols();
      
      // Main tab clicks (Active/Completed)
      document.querySelectorAll('.main-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          mainView = tab.dataset.view;
          currentStatusFilter = null;
          document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
          
          // Toggle stats bars
          document.getElementById('activeStats').style.display = mainView === 'active' ? 'grid' : 'none';
          document.getElementById('completedStats').style.display = mainView === 'completed' ? 'grid' : 'none';
          
          renderProtocols();
        });
      });
      
      // Filter tab clicks (All/In Clinic/Take Home)
      document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentFilter = tab.dataset.filter;
          renderProtocols();
        });
      });
    });

    function handleSearch() {
      searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
      renderProtocols();
    }

    function clearSearch() {
      searchTerm = '';
      document.getElementById('searchInput').value = '';
      renderProtocols();
    }

    async function loadProtocols() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('content').style.display = 'none';
      
      try {
        const res = await fetch(`${API_BASE}/pipelines/peptide`);
        const data = await res.json();
        
        if (data.success) {
          allProtocols = data.protocols;
          updateStats();
          renderProtocols();
        } else {
          showToast('Failed to load protocols', 'error');
        }
      } catch (err) {
        console.error('Load error:', err);
        showToast('Failed to load protocols', 'error');
      }
      
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';
    }

    function updateStats() {
      const now = new Date();
      let ending = 0, active = 0, started = 0, completed = 0, needsFollowup = 0;
      
      allProtocols.forEach(p => {
        if (p.status === 'completed') {
          completed++;
          return;
        }
        
        const daysRemaining = p.days_remaining || 0;
        
        if (daysRemaining <= 0) {
          completed++;
        } else if (daysRemaining <= 3) {
          ending++;
        } else if (daysRemaining <= 14) {
          active++;
        } else {
          started++;
        }
        
        // Check if take-home needs follow-up (7+ days since start, no check-in)
        if (p.delivery_method === 'take_home' && p.days_since_start >= 7 && !p.last_checkin) {
          needsFollowup++;
        }
      });
      
      document.getElementById('stat-ending').textContent = ending;
      document.getElementById('stat-active').textContent = active;
      document.getElementById('stat-started').textContent = started;
      document.getElementById('stat-completed').textContent = completed;
      document.getElementById('stat-followup').textContent = needsFollowup;
    }

    function filterByStatus(status) {
      // Toggle status filter
      if (currentStatusFilter === status) {
        currentStatusFilter = null;
        document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
      } else {
        currentStatusFilter = status;
        document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
        document.querySelector(`.stat-card[data-status="${status}"]`)?.classList.add('active');
      }
      renderProtocols();
    }

    function getProtocolStatus(p) {
      if (p.status === 'completed' || p.days_remaining <= 0) return 'completed';
      if (p.days_remaining <= 3) return 'ending';
      if (p.days_remaining <= 14) return 'active';
      return 'started';
    }

    function needsFollowup(p) {
      return p.delivery_method === 'take_home' && p.days_since_start >= 7 && !p.last_checkin;
    }

    function renderProtocols() {
      let filtered = allProtocols;
      
      // When searching, show ALL protocols (both active and completed)
      // Otherwise, apply main view filter
      if (searchTerm) {
        // Search across all protocols
        filtered = filtered.filter(p => 
          (p.patient_name || '').toLowerCase().includes(searchTerm) ||
          (p.medication || '').toLowerCase().includes(searchTerm)
        );
        
        // Apply delivery method filter even when searching
        if (currentFilter !== 'all') {
          filtered = filtered.filter(p => p.delivery_method === currentFilter);
        }
        
        // When searching, group by active vs completed
        const activeResults = filtered.filter(p => getProtocolStatus(p) !== 'completed');
        const completedResults = filtered.filter(p => getProtocolStatus(p) === 'completed');
        
        let html = '';
        
        // Show active results grouped by status
        if (activeResults.length > 0) {
          const groups = {
            ending: activeResults.filter(p => getProtocolStatus(p) === 'ending'),
            active: activeResults.filter(p => getProtocolStatus(p) === 'active'),
            started: activeResults.filter(p => getProtocolStatus(p) === 'started')
          };
          
          Object.keys(groups).forEach(key => {
            groups[key].sort((a, b) => (a.days_remaining || 999) - (b.days_remaining || 999));
          });
          
          if (groups.ending.length > 0) {
            html += renderSection('üî¥ Ending Soon (‚â§3 days)', groups.ending);
          }
          if (groups.active.length > 0) {
            html += renderSection('üü° Active (4-14 days remaining)', groups.active);
          }
          if (groups.started.length > 0) {
            html += renderSection('üü¢ Just Started (15+ days remaining)', groups.started);
          }
        }
        
        // Show completed results
        if (completedResults.length > 0) {
          completedResults.sort((a, b) => new Date(b.end_date || 0) - new Date(a.end_date || 0));
          html += renderSection('‚ö™ Completed Protocols', completedResults);
        }
        
        if (html === '') {
          html = `
            <div class="empty-state">
              <div class="icon">üîç</div>
              <p>No protocols found matching "${searchTerm}".</p>
              <p style="margin-top: 8px;"><button class="action-btn" onclick="clearSearch()">Clear Search</button></p>
            </div>
          `;
        }
        
        document.getElementById('content').innerHTML = html;
        return;
      }
      
      // Normal view (no search) - apply main view filter (active vs completed)
      if (mainView === 'active') {
        filtered = filtered.filter(p => getProtocolStatus(p) !== 'completed');
      } else {
        filtered = filtered.filter(p => getProtocolStatus(p) === 'completed');
      }
      
      // Apply delivery method filter
      if (currentFilter !== 'all') {
        filtered = filtered.filter(p => p.delivery_method === currentFilter);
      }
      
      // Apply status filter (only for active view)
      if (currentStatusFilter && mainView === 'active') {
        if (currentStatusFilter === 'needs-followup') {
          filtered = filtered.filter(p => needsFollowup(p));
        } else {
          filtered = filtered.filter(p => getProtocolStatus(p) === currentStatusFilter);
        }
      }
      
      let html = '';
      
      if (mainView === 'active') {
        // Group by status for active view
        const groups = {
          ending: filtered.filter(p => getProtocolStatus(p) === 'ending'),
          active: filtered.filter(p => getProtocolStatus(p) === 'active'),
          started: filtered.filter(p => getProtocolStatus(p) === 'started')
        };
        
        // Sort each group by days remaining
        Object.keys(groups).forEach(key => {
          groups[key].sort((a, b) => (a.days_remaining || 999) - (b.days_remaining || 999));
        });
        
        if (groups.ending.length > 0) {
          html += renderSection('üî¥ Ending Soon (‚â§3 days)', groups.ending);
        }
        if (groups.active.length > 0) {
          html += renderSection('üü° Active (4-14 days remaining)', groups.active);
        }
        if (groups.started.length > 0) {
          html += renderSection('üü¢ Just Started (15+ days remaining)', groups.started);
        }
      } else {
        // Show all completed sorted by end date (most recent first)
        filtered.sort((a, b) => new Date(b.end_date || 0) - new Date(a.end_date || 0));
        
        if (filtered.length > 0) {
          html += renderSection('‚ö™ Completed Protocols', filtered);
        }
      }
      
      if (html === '') {
        const viewLabel = mainView === 'active' ? 'active protocols' : 'completed protocols';
        html = `
          <div class="empty-state">
            <div class="icon">${mainView === 'active' ? 'üíä' : '‚úÖ'}</div>
            <p>No ${viewLabel} found.</p>
          </div>
        `;
      }
      
      document.getElementById('content').innerHTML = html;
    }

    function renderSection(title, protocols) {
      return `
        <div class="section">
          <div class="section-header">
            <h2>${title}</h2>
            <span class="count">${protocols.length}</span>
          </div>
          <div class="patient-grid">
            ${protocols.map(p => renderPatientCard(p)).join('')}
          </div>
        </div>
      `;
    }

    function renderPatientCard(p) {
      const daysClass = p.days_remaining <= 3 ? 'urgent' : p.days_remaining <= 7 ? 'warning' : 'ok';
      const deliveryBadge = p.delivery_method === 'in_clinic' 
        ? '<span class="badge in-clinic">In Clinic</span>'
        : '<span class="badge take-home">Take Home</span>';
      
      const needsFollowupBadge = needsFollowup(p) 
        ? '<span class="badge needs-followup">Needs Follow-up</span>' 
        : '';
      
      const isCompleted = getProtocolStatus(p) === 'completed';
      
      return `
        <div class="patient-card">
          <div class="patient-info">
            <div class="field">
              <div class="field-label">Patient</div>
              <div class="field-value name">${p.patient_name || 'Unknown'}</div>
            </div>
            <div class="field">
              <div class="field-label">Peptide</div>
              <div class="field-value">${p.medication || '-'}</div>
            </div>
            <div class="field">
              <div class="field-label">Dose</div>
              <div class="field-value">${p.selected_dose || '-'}</div>
            </div>
            <div class="field">
              <div class="field-label">Duration</div>
              <div class="field-value">${p.start_date || '-'} ‚Üí ${p.end_date || '-'}</div>
            </div>
            <div class="field">
              <div class="field-label">Days Remaining</div>
              <div class="field-value days-remaining ${daysClass}">${isCompleted ? 'Done' : (p.days_remaining || 0) + ' days'}</div>
            </div>
            <div class="field">
              <div class="field-label">Delivery</div>
              <div class="field-value">${deliveryBadge} ${needsFollowupBadge}</div>
            </div>
          </div>
          <div class="patient-actions">
            ${p.delivery_method === 'take_home' ? `
              <button class="action-btn" onclick="openSmsModal('${p.id}', '${p.patient_name}', '${p.ghl_contact_id}')">
                üì± SMS
              </button>
            ` : `
              <button class="action-btn" onclick="logSession('${p.id}', '${p.patient_name}')">
                üíâ Log Session
              </button>
            `}
            <button class="action-btn" onclick="openEditModal('${p.id}')">
              ‚úèÔ∏è Edit
            </button>
            <button class="action-btn" onclick="openInGHL('${p.ghl_contact_id}')">
              ‚Üó GHL
            </button>
            ${isCompleted || p.days_remaining <= 3 ? `
              <button class="action-btn primary" onclick="openRenewModal('${p.id}', '${p.patient_name}', '${p.medication}')">
                üîÑ Renew
              </button>
            ` : ''}
            <button class="action-btn" onclick="deleteProtocol('${p.id}', '${p.patient_name}')" style="color: #dc2626;">
              üóëÔ∏è
            </button>
          </div>
        </div>
      `;
    }

    function openInGHL(contactId) {
      if (!contactId) {
        showToast('No GHL contact linked', 'error');
        return;
      }
      window.open(`https://crm.cuppconsulting.com/v2/location/WICdvbXmTjQORW6GiHWW/contacts/detail/${contactId}`, '_blank');
    }

    function openSmsModal(protocolId, patientName, contactId) {
      selectedProtocol = { id: protocolId, patientName, contactId };
      document.getElementById('smsPatientName').textContent = `To: ${patientName}`;
      document.getElementById('smsMessage').value = document.getElementById('smsMessage').value.replace('{{first_name}}', patientName.split(' ')[0]);
      document.getElementById('smsModal').classList.add('active');
    }

    function closeSmsModal() {
      document.getElementById('smsModal').classList.remove('active');
      selectedProtocol = null;
    }

    async function sendSms() {
      if (!selectedProtocol) return;
      
      const message = document.getElementById('smsMessage').value;
      
      try {
        const res = await fetch(`${API_BASE}/ghl/send-sms`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contact_id: selectedProtocol.contactId,
            message: message
          })
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('SMS sent successfully!', 'success');
          closeSmsModal();
        } else {
          showToast(data.error || 'Failed to send SMS', 'error');
        }
      } catch (err) {
        showToast('Failed to send SMS', 'error');
      }
    }

    function openRenewModal(protocolId, patientName, medication) {
      selectedProtocol = { id: protocolId, patientName, medication };
      document.getElementById('renewPatientName').textContent = `${patientName} - ${medication}`;
      document.getElementById('renewModal').classList.add('active');
    }

    function closeRenewModal() {
      document.getElementById('renewModal').classList.remove('active');
      selectedProtocol = null;
    }

    async function renewProtocol() {
      if (!selectedProtocol) return;
      
      const duration = document.getElementById('renewDuration').value;
      const notes = document.getElementById('renewNotes').value;
      
      try {
        const res = await fetch(`${API_BASE}/protocols/${selectedProtocol.id}/renew`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            duration_days: parseInt(duration),
            notes: notes
          })
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('Protocol renewed!', 'success');
          closeRenewModal();
          loadProtocols();
        } else {
          showToast(data.error || 'Failed to renew protocol', 'error');
        }
      } catch (err) {
        showToast('Failed to renew protocol', 'error');
      }
    }

    // Edit Protocol functions
    function openEditModal(protocolId) {
      const protocol = allProtocols.find(p => p.id === protocolId);
      if (!protocol) {
        showToast('Protocol not found', 'error');
        return;
      }
      
      selectedProtocol = protocol;
      
      document.getElementById('editPatientName').textContent = protocol.patient_name;
      document.getElementById('editMedication').value = protocol.medication || '';
      document.getElementById('editDose').value = protocol.selected_dose || '';
      document.getElementById('editStartDate').value = protocol.start_date || '';
      document.getElementById('editEndDate').value = protocol.end_date || '';
      document.getElementById('editDeliveryMethod').value = protocol.delivery_method || 'take_home';
      document.getElementById('editStatus').value = protocol.status || 'active';
      document.getElementById('editNotes').value = protocol.notes || '';
      
      document.getElementById('editModal').classList.add('active');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
      selectedProtocol = null;
    }

    async function saveProtocolEdit() {
      if (!selectedProtocol) return;
      
      const data = {
        medication: document.getElementById('editMedication').value,
        selected_dose: document.getElementById('editDose').value,
        start_date: document.getElementById('editStartDate').value || null,
        end_date: document.getElementById('editEndDate').value || null,
        delivery_method: document.getElementById('editDeliveryMethod').value,
        status: document.getElementById('editStatus').value,
        notes: document.getElementById('editNotes').value
      };
      
      try {
        const res = await fetch(`${API_BASE}/protocols/${selectedProtocol.id}/update`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await res.json();
        
        if (result.success) {
          showToast('Protocol updated!', 'success');
          closeEditModal();
          loadProtocols();
        } else {
          showToast(result.error || 'Failed to update', 'error');
        }
      } catch (err) {
        showToast('Failed to update protocol', 'error');
      }
    }

    async function deleteProtocol(protocolId, patientName) {
      if (!confirm(`Are you sure you want to delete the protocol for ${patientName}? This cannot be undone.`)) {
        return;
      }
      
      try {
        const res = await fetch(`${API_BASE}/protocols/${protocolId}`, {
          method: 'DELETE'
        });
        
        const result = await res.json();
        
        if (result.success) {
          showToast('Protocol deleted', 'success');
          loadProtocols();
        } else {
          showToast(result.error || 'Failed to delete', 'error');
        }
      } catch (err) {
        showToast('Failed to delete protocol', 'error');
      }
    }

    async function logSession(protocolId, patientName) {
      // For now, redirect to Staff Quick Log
      // Could build inline logging later
      const params = new URLSearchParams({ protocol_id: protocolId });
      showToast('Opening Staff Quick Log...', 'success');
      // In GHL embed, this would open the log session form
      window.open(`/staff-quick-log.html?${params}`, '_blank');
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast active ${type}`;
      setTimeout(() => {
        toast.classList.remove('active');
      }, 3000);
    }
  </script>
</body>
</html>
